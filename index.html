<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EdgePlus Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@google/generative-ai/dist/index.min.js"></script>
    <style>
        :root {
            --bg-primary: #0D1117;
            --bg-secondary: #161B22;
            --bg-tertiary: #21262D;
            --border-color: #30363D;
            --text-primary: #C9D1D9;
            --text-secondary: #8B949E;
            --accent-blue: #58A6FF;
            --accent-cyan: #39C5CF;
            --status-good: #238636;
            --status-good-bg: rgba(35, 134, 54, 0.15);
            --status-avg: #D29922;
            --status-avg-bg: rgba(210, 153, 34, 0.15);
            --status-bad: #DA3633;
            --status-bad-bg: rgba(218, 54, 51, 0.15);
            --status-completed: #A371F7; /* Purple for completed */
        }

        body.light-theme {
            --bg-primary: #F6F8FA;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F0F2F5;
            --border-color: #D0D7DE;
            --text-primary: #1F2328;
            --text-secondary: #57606A;
            --status-good-bg: rgba(35, 134, 54, 0.1);
            --status-avg-bg: rgba(210, 153, 34, 0.1);
            --status-bad-bg: rgba(218, 54, 51, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; position: relative; }

        .view { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; will-change: transform, opacity; }
        .view.hidden { opacity: 0; transform: scale(0.98); pointer-events: none; position: absolute; top: 2rem; left: 1rem; right: 1rem; width: calc(100% - 2rem); }
        .page-view.hidden { display: none; }
        #auth-wrapper.hidden, #app-wrapper.hidden { display: none; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .logo { font-size: 1.75rem; font-weight: 800; color: var(--text-primary); }
        .logo span { background: linear-gradient(45deg, var(--accent-blue), var(--accent-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-tertiary); border: 2px solid var(--border-color); object-fit: cover; }
        .hamburger-menu { background: none; border: none; cursor: pointer; padding: 0.5rem; }
        .hamburger-menu svg { width: 24px; height: 24px; color: var(--text-secondary); }

        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); }
        
        /* --- Authentication Styles --- */
        #auth-wrapper { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; }
        .auth-card { background: var(--bg-secondary); padding: 2.5rem; border-radius: 16px; border: 1px solid var(--border-color); width: 100%; max-width: 400px; text-align: center; }
        .auth-card .logo { margin-bottom: 2rem; }
        .auth-form { display: flex; flex-direction: column; gap: 1.25rem; }
        .auth-form.hidden { display: none; }
        .auth-toggle-link { color: var(--accent-cyan); cursor: pointer; margin-top: 1.5rem; font-size: 0.9rem; }
        .auth-error { color: var(--status-bad); margin-top: 1rem; font-size: 0.9rem; min-height: 1.2rem; }

        /* --- Side Drawer Styles --- */
        #drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1001; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #drawer-overlay.visible { opacity: 1; pointer-events: auto; }
        #side-drawer { position: fixed; top: 0; right: 0; width: 280px; height: 100%; background: var(--bg-secondary); z-index: 1002; transform: translateX(100%); transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease; display: flex; flex-direction: column; border-left: 1px solid var(--border-color); }
        #side-drawer.open { transform: translateX(0); }
        .drawer-header { padding: 1.5rem; text-align: center; border-bottom: 1px solid var(--border-color); }
        .drawer-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 3px solid var(--accent-blue); }
        .drawer-username { font-size: 1.1rem; font-weight: 600; }
        .drawer-nav { flex-grow: 1; padding: 1rem 0; }
        .drawer-nav a { display: block; padding: 1rem 1.5rem; color: var(--text-primary); text-decoration: none; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .drawer-nav a:hover { background-color: var(--bg-tertiary); color: var(--accent-cyan); }
        .drawer-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .theme-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .theme-toggle label {
            font-weight: 500;
            color: var(--text-primary);
        }
        .theme-toggle .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .theme-toggle .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .theme-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            transition: .4s;
            border-radius: 28px;
        }
        .theme-toggle .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        body:not(.light-theme) .theme-toggle .slider:before {
            background-color: var(--bg-primary);
        }
        .theme-toggle input:checked + .slider {
            background-color: var(--accent-blue);
        }
        .theme-toggle input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* --- Profile View Styles --- */
        #profile-view .card { padding: 2.5rem; }
        .profile-grid { display: grid; grid-template-columns: 1fr; gap: 2.5rem; }
        @media (min-width: 768px) { .profile-grid { grid-template-columns: 2fr 1fr; } }
        .profile-pic-section { text-align: center; }
        .profile-pic-preview { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); margin: 0 auto 1rem; display: block; }
        .profile-pic-label { display: inline-block; background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.75rem 1.25rem; border-radius: 8px; cursor: pointer; }
        .profile-pic-label:hover { border-color: var(--accent-blue); }
        #profilePicInput { display: none; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .overall-performance-card { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: center; background: linear-gradient(135deg, var(--bg-secondary) 0%, #1A2230 100%); }
        body.light-theme .overall-performance-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, #E8ECF2 100%);
        }
        .account-card { cursor: pointer; }
        .account-card-actions { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .account-card:hover .account-card-actions { opacity: 1; }
        .action-btn { background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-secondary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .action-btn:hover { background-color: #2a3038; color: var(--text-primary); }
        body.light-theme .action-btn:hover { background-color: #e1e4e8; }
        .add-account-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 230px; cursor: pointer; border: 2px dashed var(--border-color); transition: border-color 0.2s, background-color 0.2s; }
        .add-account-card:hover { border-color: var(--accent-blue); background-color: var(--bg-tertiary); }
        .add-icon { width: 48px; height: 48px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; color: var(--accent-cyan); }
        .account-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .account-card-header h3 { font-size: 1.25rem; font-weight: 600; padding-right: 0.5rem; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.good { background-color: var(--status-good); }
        .status-dot.average { background-color: var(--status-avg); }
        .status-dot.bad { background-color: var(--status-bad); }
        .phase-badge {
            display: inline-block;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            line-height: 1.2;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .metric { display: flex; align-items: center; gap: 0.75rem; }
        .metric-icon { background-color: var(--bg-tertiary); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .metric-icon svg { width: 20px; height: 20px; color: var(--accent-cyan); }
        .metric-value { font-size: 1.5rem; font-weight: 700; }
        .metric-label { font-size: 0.8rem; color: var(--text-secondary); }
        .profit-metric .metric-value.pnl-profit { color: var(--status-good); }
        .profit-metric .metric-value.pnl-loss { color: var(--status-bad); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal { background: var(--bg-secondary); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease-in-out; }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 600; }
        .close-modal { background: none; border: none; font-size: 2rem; color: var(--text-secondary); cursor: pointer; line-height: 1; }
        #account-form, #profile-form, #goal-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; display: block; }
        .form-group input, .form-group select, .form-group textarea { background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 1rem; width: 100%; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2); }
        .modal-submit { background: linear-gradient(45deg, var(--accent-blue), var(--accent-cyan)); color: var(--bg-primary); font-weight: 700; border: none; border-radius: 8px; padding: 0.85rem; cursor: pointer; transition: transform 0.2s; grid-column: 1 / -1; margin-top: 1rem; }
        body.light-theme .modal-submit { color: #FFFFFF; }
        .modal-submit:hover { transform: translateY(-2px); }
        .back-button { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.75rem 1.25rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 2rem; transition: background-color 0.2s ease; }
        .back-button:hover { background-color: var(--bg-tertiary); }
        .back-button:disabled { cursor: not-allowed; opacity: 0.6; }
        .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; }
        .stat-card-title { color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .stat-card-value { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem; }
        .metric-group { display: flex; justify-content: space-between; align-items: baseline; }
        .metric-group .stat-card-value { font-size: 1.5rem; }
        .performance-chart-svg { width: 100%; height: 100px; }
        .chart-area { fill: url(#chartGradient); opacity: 0.4; }
        .chart-line { fill: none; stroke: var(--accent-cyan); stroke-width: 2.5; }
        .trade-journal-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .form-group select, .form-group textarea, .form-group input[type="date"] { background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 1rem; width: 100%; }
        .form-group.full-span { grid-column: 1 / -1; }
        textarea { resize: vertical; min-height: 80px; }
        .add-trade-button { grid-column: 1 / -1; background: linear-gradient(45deg, var(--accent-blue), var(--accent-cyan)); color: var(--bg-primary); font-weight: 700; font-size: 1rem; border: none; border-radius: 8px; padding: 0.85rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 1rem; }
        body.light-theme .add-trade-button { color: #FFFFFF; }
        .trade-log-container { overflow-x: auto; }
        .trade-log-table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
        .trade-log-table th, .trade-log-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .trade-log-table th { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; }
        .pnl-profit { color: var(--status-good); font-weight: 600; }
        .pnl-loss { color: var(--status-bad); font-weight: 600; }
        .pnl-avg { color: var(--status-avg); font-weight: 600; }
        .file-input-wrapper { position: relative; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 1rem; width: 100%; cursor: pointer; text-align: center; }
        .file-input-wrapper:hover { border-color: var(--accent-blue); }
        .file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-name { font-size: 0.9rem; color: var(--text-secondary); margin-left: 0.5rem; }
        .attachment-link { color: var(--accent-cyan); text-decoration: none; }
        .attachment-link:hover { text-decoration: underline; }
        .attachment-link svg { width: 18px; height: 18px; vertical-align: middle; }
        .mistake-tag { background-color: var(--status-bad-bg); color: var(--status-bad); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin: 0.1rem; display: inline-block; }

        /* --- Goals View Styles --- */
        #goals-view .header { border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .goal-card { display: flex; flex-direction: column; gap: 1rem; }
        .goal-card .account-card-actions { z-index: 10; }
        .goal-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .goal-header h3 { font-size: 1.1rem; font-weight: 600; padding-right: 4rem; }
        .goal-target { color: var(--text-secondary); font-size: 0.9rem; margin-top: -0.5rem; }
        .progress-bar-container { width: 100%; background-color: var(--bg-tertiary); border-radius: 8px; height: 12px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan)); border-radius: 8px; transition: width 0.5s ease; }
        .progress-text { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; }
        .goal-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 0.5rem; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 16px; font-weight: 600; font-size: 0.8rem; text-transform: capitalize; }
        .status-badge.status-ongoing { background-color: var(--status-avg-bg); color: var(--status-avg); }
        .status-badge.status-completed { background-color: rgba(163, 113, 247, 0.15); color: var(--status-completed); }
        .status-badge.status-failed { background-color: var(--status-bad-bg); color: var(--status-bad); }
        .deadline { font-size: 0.8rem; color: var(--text-secondary); }
        .goal-status-actions { display: flex; gap: 0.5rem; }
        .status-action-btn { background: none; border: 1px solid var(--border-color); border-radius: 6px; padding: 0.3rem 0.6rem; font-size: 0.8rem; cursor: pointer; color: var(--text-secondary); }
        .status-action-btn:hover { border-color: var(--text-primary); color: var(--text-primary); }
        .status-action-btn.complete:hover { border-color: var(--status-completed); color: var(--status-completed); }
        .status-action-btn.fail:hover { border-color: var(--status-bad); color: var(--status-bad); }
        #goals-grid .add-account-card { min-height: auto; padding: 3rem 1.5rem; }
        
        /* --- Overall Comparison Styles --- */
        .comparison-card { grid-column: 1 / -1; display: flex; flex-direction: column; gap: 1.5rem; }
        .comparison-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; }
        .comparison-header h3 { font-size: 1.25rem; font-weight: 600; }
        .comparison-controls { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; }
        .toggle-group { display: flex; background-color: var(--bg-tertiary); border-radius: 8px; padding: 4px; border: 1px solid var(--border-color); }
        .toggle-group button { background: transparent; border: none; color: var(--text-secondary); padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .toggle-group button.active { background-color: var(--bg-secondary); color: var(--text-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        body.light-theme .toggle-group button.active { background-color: var(--bg-primary); }
        .comparison-body { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
        @media (max-width: 992px) { .comparison-body { grid-template-columns: 1fr; } }
        #comparison-chart-container { position: relative; width: 100%; height: 350px; }
        .comparison-chart-svg { width: 100%; height: 100%; }
        .comparison-chart-tooltip { position: absolute; background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.75rem; border-radius: 8px; font-size: 0.8rem; pointer-events: none; opacity: 0; transition: opacity 0.2s, transform 0.1s; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.3); top: 0; left: 0; }
        .tooltip-title { font-weight: 600; margin-bottom: 0.5rem; }
        .tooltip-item { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem; }
        .tooltip-swatch { width: 10px; height: 10px; border-radius: 3px; }
        #comparison-chart-legend { display: flex; flex-wrap: wrap; gap: 0.75rem 1.5rem; margin-top: 1rem; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; cursor: pointer; opacity: 1; transition: opacity 0.2s; }
        .legend-item.hidden { opacity: 0.4; }
        .legend-swatch { width: 12px; height: 12px; border-radius: 3px; }
        .legend-pnl { font-weight: 600; font-size: 0.75rem; margin-left: 0.25rem; }
        .comparison-list-pane { max-height: 400px; overflow-y: auto; }
        .comparison-table { width: 100%; border-collapse: collapse; }
        .comparison-table th { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; text-align: left; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .comparison-table th .sort-icon { display: inline-block; margin-left: 4px; opacity: 0.5; }
        .comparison-table td { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 0.875rem; }
        .comparison-table tr:last-child td { border-bottom: none; }
        .comparison-table tr { cursor: pointer; transition: background-color 0.2s; }
        .comparison-table tr:hover { background-color: var(--bg-tertiary); }
        .rank-cell { font-weight: 600; text-align: center; }
        .sparkline-svg { width: 80px; height: 30px; }
        .sparkline-line { fill: none; stroke-width: 2; }

        /* --- Smart Insights Styles --- */
        .insights-card { grid-column: 1 / -1; margin-top: 1.5rem; }
        .insights-list { list-style: none; padding: 0; margin-top: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .insight-item { display: flex; align-items: flex-start; gap: 1rem; font-size: 0.9rem; }
        .insight-item p { margin: 0; color: var(--text-primary); line-height: 1.5; }
        .insight-dot {
            flex-shrink: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-top: 5px;
        }
        .insight-dot.red { background-color: var(--status-bad); box-shadow: 0 0 8px var(--status-bad); }
        .insight-dot.yellow { background-color: var(--status-avg); box-shadow: 0 0 8px var(--status-avg); }
        .insight-dot.green { background-color: var(--status-good); box-shadow: 0 0 8px var(--status-good); }
        
        /* --- Trash View Styles --- */
        .trash-card-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        .trash-action-btn {
            flex-grow: 1;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .trash-action-btn.restore {
            border-color: var(--status-good);
            color: var(--status-good);
        }
        .trash-action-btn.restore:hover {
            background-color: var(--status-good-bg);
        }
        .trash-action-btn.perm-delete {
            border-color: var(--status-bad);
            color: var(--status-bad);
        }
        .trash-action-btn.perm-delete:hover {
            background-color: var(--status-bad-bg);
        }
        
        /* --- AI Assistant Styles --- */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(88, 166, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(88, 166, 255, 0); }
        }
        #assistant-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1010;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease-in-out;
            border: none;
        }
        #assistant-fab:hover {
            transform: scale(1.1);
        }
        #assistant-fab.pulse {
            animation: pulse 2s infinite;
        }
        #assistant-panel {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 90%;
            max-width: 400px;
            height: 60vh;
            max-height: 550px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 1009;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        #assistant-panel.visible {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        @media (max-width: 480px) {
            #assistant-fab { bottom: 1rem; right: 1rem; width: 50px; height: 50px; }
            #assistant-panel { bottom: 4.5rem; right: 1rem; width: calc(100% - 2rem); }
        }
        .assistant-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .assistant-header .logo { font-size: 1.1rem; }
        .assistant-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .assistant-message {
            display: flex;
            gap: 0.75rem;
            max-width: 90%;
        }
        .assistant-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .assistant-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .assistant-message-content {
            background-color: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-primary);
        }
        .assistant-message.user .assistant-message-content {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
        }
        body.light-theme .assistant-message.user .assistant-message-content {
             color: #FFFFFF;
        }
        .assistant-message-content table {
            width: 100%;
            margin-top: 0.5rem;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .assistant-message-content th, .assistant-message-content td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .assistant-message-content th { font-weight: 600; }
        .assistant-message-content .sparkline-svg { margin: 0.5rem 0; background: var(--bg-primary); border-radius: 4px; }
        .assistant-footer {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        #assistant-suggestions {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.75rem;
            scrollbar-width: none; /* Firefox */
        }
        #assistant-suggestions::-webkit-scrollbar { display: none; }
        .suggestion-chip {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s, color 0.2s;
        }
        .suggestion-chip:hover {
            background-color: #2a3038;
            color: var(--text-primary);
        }
         body.light-theme .suggestion-chip:hover { background-color: #e1e4e8; }
        .assistant-input-form {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }
        #assistant-input {
            flex-grow: 1;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.6rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
        }
        #assistant-input:focus { outline: none; border-color: var(--accent-blue); }
        #assistant-send-btn {
            background: var(--accent-blue);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        #assistant-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .message-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }
        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }
        .toolbar-btn:hover { color: var(--text-primary); }


        @media (max-width: 767px) {
            .pie-chart-layout {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <!-- Auth View -->
    <div id="auth-wrapper" class="hidden">
        <div class="auth-card">
            <div class="logo">Edge<span>Plus</span></div>
            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <div class="form-group full-width" style="text-align: left;"><label for="loginEmail">Email</label><input type="email" id="loginEmail" required /></div>
                <div class="form-group full-width" style="text-align: left;"><label for="loginPassword">Password</label><input type="password" id="loginPassword" required /></div>
                <button type="submit" class="modal-submit">Login</button>
                <div id="auth-error" class="auth-error"></div>
                <p class="auth-toggle-link" id="show-signup">Don't have an account? Sign Up</p>
            </form>
            <!-- Signup Form -->
            <form id="signup-form" class="auth-form hidden">
                <div class="form-group full-width" style="text-align: left;"><label for="signupName">Full Name</label><input type="text" id="signupName" required /></div>
                <div class="form-group full-width" style="text-align: left;"><label for="signupEmail">Email</label><input type="email" id="signupEmail" required /></div>
                <div class="form-group full-width" style="text-align: left;"><label for="signupPassword">Password</label><input type="password" id="signupPassword" required /></div>
                <button type="submit" class="modal-submit">Sign Up</button>
                <p class="auth-toggle-link" id="show-login">Already have an account? Login</p>
            </form>
        </div>
    </div>

    <!-- Main App Wrapper -->
    <div id="app-wrapper" class="hidden">
        <div class="container">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view page-view">
                <header class="header">
                    <div class="logo">Edge<span>Plus</span></div>
                    <div class="header-actions">
                        <img id="header-avatar" class="user-avatar" alt="User Avatar">
                        <button id="hamburger-btn" class="hamburger-menu">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                        </button>
                    </div>
                </header>
                <main id="dashboard-main">
                    <!-- Overall performance and comparison will be rendered here -->
                    <div class="dashboard-grid" id="dashboard-grid-content"></div>
                </main>
            </div>

            <!-- Account Detail View -->
            <div id="account-detail-view" class="view hidden page-view"></div>
            
            <!-- Profile View -->
            <div id="profile-view" class="view hidden page-view"></div>

             <!-- Goals View -->
            <div id="goals-view" class="view hidden page-view"></div>

            <!-- Exit Analysis View -->
            <div id="exit-analysis-view" class="view hidden page-view"></div>

             <!-- Trash View -->
            <div id="trash-view" class="view hidden page-view"></div>
            
            <!-- Withdrawal History View -->
            <div id="withdrawal-history-view" class="view hidden page-view"></div>
        </div>

        <!-- AI Assistant -->
        <button id="assistant-fab">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="4" y="12" width="8" height="8" rx="2"/><path d="M8 12v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2"/><path d="m18 13 2.5 2.5L23 13"/><path d="m18 7 2.5-2.5L23 7"/></svg>
        </button>

        <div id="assistant-panel">
            <div class="assistant-header">
                <div class="assistant-avatar" style="background: linear-gradient(45deg, var(--accent-blue), var(--accent-cyan));">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="4" y="12" width="8" height="8" rx="2"/><path d="M8 12v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2"/></svg>
                </div>
                <h3 class="logo" style="margin:0;">Edge<span>Plus</span> Assistant</h3>
            </div>
            <div class="assistant-body" id="assistant-body">
                <!-- Messages will be rendered here -->
            </div>
            <div class="assistant-footer">
                <div id="assistant-suggestions">
                    <button class="suggestion-chip">Last 10 days P/L</button>
                    <button class="suggestion-chip">Compare all funded accounts</button>
                    <button class="suggestion-chip">My common mistakes</button>
                    <button class="suggestion-chip">Withdrawal history</button>
                </div>
                <form class="assistant-input-form" id="assistant-input-form">
                    <textarea id="assistant-input" placeholder="Ask about your accounts..." rows="1"></textarea>
                    <button id="assistant-send-btn" type="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
            </div>
        </div>

    </div>

    <!-- Side Drawer & Overlay -->
    <div id="drawer-overlay"></div>
    <nav id="side-drawer">
        <div class="drawer-header">
            <img id="drawer-avatar" class="drawer-avatar" alt="User Avatar">
            <h3 id="drawer-username" class="drawer-username"></h3>
        </div>
        <div class="drawer-nav">
            <a href="#" id="nav-dashboard">Dashboard</a>
            <a href="#" id="nav-profile">Profile</a>
            <a href="#" id="nav-goals">Goals</a>
            <a href="#" id="nav-exit-analysis">Exit Analysis</a>
            <a href="#" id="nav-trash">Trash</a>
            <a href="#" id="nav-withdrawal-history">Withdrawal History</a>
            <a href="#" id="nav-logout">Logout</a>
        </div>
         <div class="drawer-footer">
            <div class="theme-toggle">
                <label for="theme-switch">Light Mode</label>
                <label class="switch">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </nav>

    <!-- Add/Edit Account Modal -->
    <div id="account-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">Add New Account</h2>
                <button id="close-modal-btn" class="close-modal">&times;</button>
            </div>
            <form id="account-form">
                <input type="hidden" id="accountId" />
                <div class="form-group full-width"><label for="accountName">Account Name</label><input type="text" id="accountName" required /></div>
                <div class="form-group"><label for="allocatedFunds">Allocated Funds ($)</label><input type="number" id="allocatedFunds" step="any" required /></div>
                <div class="form-group">
                    <label for="accountPhase">Phase</label>
                    <select id="accountPhase" required>
                        <option value="1st">1st</option>
                        <option value="2nd">2nd</option>
                        <option value="Passed">Passed</option>
                        <option value="Demo">Demo</option>
                    </select>
                </div>
                <div class="form-group"><label for="netProfit">Net Profit ($)</label><input type="number" id="netProfit" step="any" required value="0" /></div>
                <div class="form-group"><label for="lossLimit">Loss Limit (%)</label><input type="number" id="lossLimit" step="any" placeholder="e.g., 10 for 10%" /></div>
                <button type="submit" class="modal-submit">Save Account</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Goal Modal -->
    <div id="goal-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="goal-modal-title" class="modal-title">Set New Goal</h2>
                <button id="close-goal-modal-btn" class="close-modal">&times;</button>
            </div>
            <form id="goal-form">
                <input type="hidden" id="goalId" />
                <div class="form-group full-width"><label for="goalTitle">Goal Title</label><input type="text" id="goalTitle" required placeholder="e.g., Reach $500 profit" /></div>
                <div class="form-group full-width"><label for="goalAccount">Link to Account</label><select id="goalAccount" required></select></div>
                <div class="form-group">
                    <label for="goalType">Goal Type</label>
                    <select id="goalType" required>
                        <option value="profit">Profit ($)</option>
                        <option value="win_rate">Win Rate (%)</option>
                        <option value="consistency">Trading Days</option>
                        <option value="avg_rr">Average R:R</option>
                        <option value="total_trades">Total Trades</option>
                    </select>
                </div>
                <div class="form-group"><label for="goalTarget">Target Value</label><input type="number" id="goalTarget" step="any" required /></div>
                <div class="form-group full-width"><label for="goalDeadline">Deadline (Optional)</label><input type="date" id="goalDeadline" /></div>
                <button type="submit" class="modal-submit">Save Goal</button>
            </form>
        </div>
    </div>

    <!-- Note Detail Modal -->
    <div id="note-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Trade Note</h2>
                <button id="close-note-modal-btn" class="close-modal">&times;</button>
            </div>
            <div id="note-modal-content" style="white-space: pre-wrap; line-height: 1.6; color: var(--text-secondary); max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Add Withdrawal Modal -->
    <div id="withdrawal-modal" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="withdrawal-modal-title" class="modal-title">Add Withdrawal</h2>
                <button id="close-withdrawal-modal-btn" class="close-modal">&times;</button>
            </div>
            <form id="withdrawal-form" style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="hidden" id="withdrawalAccountId" />
                <div class="form-group full-width">
                    <label for="withdrawalAmount">Amount ($)</label>
                    <input type="number" id="withdrawalAmount" step="any" required />
                </div>
                <div class="form-group full-width">
                    <label for="withdrawalDate">Date</label>
                    <input type="date" id="withdrawalDate" required />
                </div>
                <div class="form-group full-width">
                    <label for="withdrawalNotes">Notes (Optional)</label>
                    <textarea id="withdrawalNotes" rows="3" style="min-height: 60px;"></textarea>
                </div>
                <button type="submit" class="modal-submit">Save Withdrawal</button>
            </form>
        </div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA (State) ---
            let users = [];
            try {
                const storedUsers = localStorage.getItem('edgeplus_users');
                users = storedUsers ? JSON.parse(storedUsers) : [];
                if (!Array.isArray(users)) {
                    users = [];
                }
            } catch (e) {
                console.error("Error parsing users from localStorage", e);
                users = [];
            }
            let currentUserEmail = localStorage.getItem('edgeplus_currentUser');
            let currentUser = null;

            // --- THEME ---
            const themeSwitch = document.getElementById('theme-switch');
            const currentTheme = localStorage.getItem('edgeplus_theme') || 'dark';

            const applyTheme = (theme) => {
                if (theme === 'light') {
                    document.body.classList.add('light-theme');
                    themeSwitch.checked = true;
                } else {
                    document.body.classList.remove('light-theme');
                    themeSwitch.checked = false;
                }
            };

            applyTheme(currentTheme);

            themeSwitch.addEventListener('change', () => {
                const theme = themeSwitch.checked ? 'light' : 'dark';
                localStorage.setItem('edgeplus_theme', theme);
                applyTheme(theme);
            });

            // --- DOM ELEMENTS ---
            const authWrapper = document.getElementById('auth-wrapper');
            const appWrapper = document.getElementById('app-wrapper');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const showSignupBtn = document.getElementById('show-signup');
            const showLoginBtn = document.getElementById('show-login');
            const dashboardView = document.getElementById('dashboard-view');
            const accountDetailView = document.getElementById('account-detail-view');
            const profileView = document.getElementById('profile-view');
            const goalsView = document.getElementById('goals-view');
            const exitAnalysisView = document.getElementById('exit-analysis-view');
            const trashView = document.getElementById('trash-view');
            const withdrawalHistoryView = document.getElementById('withdrawal-history-view');
            const dashboardMain = document.getElementById('dashboard-main');
            const dashboardGrid = document.getElementById('dashboard-grid-content');
            const modal = document.getElementById('account-modal');
            const goalModal = document.getElementById('goal-modal');
            const noteModal = document.getElementById('note-modal');
            const withdrawalModal = document.getElementById('withdrawal-modal');
            const accountForm = document.getElementById('account-form');
            const goalForm = document.getElementById('goal-form');
            const withdrawalForm = document.getElementById('withdrawal-form');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const sideDrawer = document.getElementById('side-drawer');
            const drawerOverlay = document.getElementById('drawer-overlay');

            // --- ICONS ---
            const icons = {
                balance: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12V8H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h12v4"></path><path d="M4 6v12a2 2 0 0 0 2 2h12v-4"></path><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2a2 2 0 0 0 2-2c0-1.1-.9-2-2-2Z"></path></svg>`,
                equity: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="4"></line><polyline points="18 10 12 4 6 10"></polyline></svg>`,
                profit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
                edit: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`,
                delete: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
                add: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
                stats: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10M18 20V4M6 20V16"/></svg>`,
                trades: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>`,
                calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
                chart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 20 10 4 8 12 2 12"/></svg>`,
                clip: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>`,
                export: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
                target: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`
            };
            
            // --- DATA & UTILITY FUNCTIONS ---
            const saveUsers = () => localStorage.setItem('edgeplus_users', JSON.stringify(users));
            const formatCurrency = (value) => `$${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const getPerformanceStatus = (equity, allocatedFunds) => {
                const profitPercent = allocatedFunds > 0 ? ((equity - allocatedFunds) / allocatedFunds) * 100 : 0;
                if (profitPercent > 5) return 'good';
                if (profitPercent > -2) return 'average';
                return 'bad';
            };
            const calculateOverallPerformance = () => {
                const totalEquity = currentUser.accounts.reduce((sum, acc) => sum + acc.equity, 0);
                const totalAllocatedFunds = currentUser.accounts.reduce((sum, acc) => sum + acc.allocatedFunds, 0);
                const profitPercent = totalAllocatedFunds > 0 ? ((totalEquity - totalAllocatedFunds) / totalAllocatedFunds) * 100 : 0;
                return { totalEquity, totalAllocatedFunds, profitPercent };
            };
            const calculateOverallWinRate = () => {
                const allTrades = currentUser.accounts.flatMap(acc => acc.trades);
                
                if (allTrades.length === 0) return 0;

                allTrades.sort((a, b) => new Date(b.date) - new Date(a.date));

                const recentTrades = allTrades.slice(0, 100);
                const winningTrades = recentTrades.filter(t => t.pnl > 0).length;
                const totalConsidered = recentTrades.length;

                if (totalConsidered === 0) return 0;

                return (winningTrades / totalConsidered) * 100;
            };
             const readFileAsDataURL = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };
            const generateAvatar = (name) => {
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#161B22'; // --bg-secondary
                ctx.fillRect(0, 0, 100, 100);
                ctx.font = 'bold 40px Inter';
                ctx.fillStyle = '#C9D1D9'; // --text-primary
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(initials, 50, 50);
                return canvas.toDataURL();
            };
            const getFilteredTrades = (account, filters) => {
                if (!filters) return [...account.trades];
                const { fromDate, toDate, moodFilter, entryFilter, exitFilter, mistakeFilter, pairFilter, typeFilter, sessionFilter, timeFrameFilter } = filters;
                let tradesToDisplay = [...account.trades];

                if (fromDate) {
                    const from = new Date(fromDate);
                    from.setHours(0, 0, 0, 0); // Start of the day
                    tradesToDisplay = tradesToDisplay.filter(trade => new Date(trade.date) >= from);
                }
                if (toDate) {
                    const to = new Date(toDate);
                    to.setHours(23, 59, 59, 999); // End of the day
                    tradesToDisplay = tradesToDisplay.filter(trade => new Date(trade.date) <= to);
                }
                if (pairFilter && pairFilter !== 'All') {
                    tradesToDisplay = tradesToDisplay.filter(trade => trade.pair === pairFilter);
                }
                if (typeFilter && typeFilter !== 'All') {
                    tradesToDisplay = tradesToDisplay.filter(trade => trade.type === typeFilter);
                }
                if (sessionFilter && sessionFilter !== 'All') {
                    tradesToDisplay = tradesToDisplay.filter(trade => trade.session === sessionFilter);
                }
                if (timeFrameFilter && timeFrameFilter !== 'All') {
                    tradesToDisplay = tradesToDisplay.filter(trade => trade.timeFrame === timeFrameFilter);
                }
                if (moodFilter && moodFilter !== 'All') {
                    tradesToDisplay = tradesToDisplay.filter(trade => trade.mood === moodFilter);
                }
                if (entryFilter && entryFilter !== 'All') {
                    tradesToDisplay = tradesToDisplay.filter(trade => trade.entryReason === entryFilter);
                }
                if (exitFilter && exitFilter !== 'All') {
                    tradesToDisplay = tradesToDisplay.filter(trade => trade.exitReason === exitFilter);
                }
                if (mistakeFilter && mistakeFilter !== 'All') {
                    tradesToDisplay = tradesToDisplay.filter(trade => trade.mistakes && trade.mistakes.includes(mistakeFilter));
                }
                return tradesToDisplay;
            };

            // --- VIEW MANAGEMENT ---
            const switchView = (viewToShow) => {
                [dashboardView, accountDetailView, profileView, goalsView, exitAnalysisView, trashView, withdrawalHistoryView].forEach(v => v.classList.add('hidden'));
                viewToShow.classList.remove('hidden');
                window.scrollTo(0, 0);
            };

            // --- RENDER FUNCTIONS ---
            const renderDashboard = () => {
                dashboardMain.innerHTML = '';
                const { totalEquity, totalAllocatedFunds, profitPercent } = calculateOverallPerformance();
                const overallWinRate = calculateOverallWinRate();
                
                const overallPerfCardHTML = `
                    <div class="card overall-performance-card">
                        <div class="metric"><div class="metric-icon">${icons.balance}</div><div><p class="metric-value">${formatCurrency(totalAllocatedFunds)}</p><p class="metric-label">Total Allocated Funds</p></div></div>
                        <div class="metric"><div class="metric-icon">${icons.equity}</div><div><p class="metric-value">${formatCurrency(totalEquity)}</p><p class="metric-label">Total Equity</p></div></div>
                        <div class="metric profit-metric"><div class="metric-icon">${icons.profit}</div><div><p class="metric-value ${profitPercent >= 0 ? 'pnl-profit' : 'pnl-loss'}">${profitPercent.toFixed(2)}%</p><p class="metric-label">Overall Profit</p></div></div>
                        <div class="metric"><div class="metric-icon">${icons.target}</div><div><p class="metric-value">${overallWinRate.toFixed(1)}%</p><p class="metric-label">Win Rate</p></div></div>
                    </div>`;

                const insightsCardHTML = `<div class="card insights-card" id="smart-insights-container"></div>`;
                const exitAnalysisWidgetsHTML = `<div id="exit-analysis-widgets-container" class="dashboard-grid" style="margin-top: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));"></div>`;
                const comparisonSectionContainer = `<div id="comparison-section-container" style="margin-top: 1.5rem;"></div>`;
                const accountGridContainer = `<div class="dashboard-grid" id="dashboard-grid-content" style="margin-top: 1.5rem;"></div>`;
                
                dashboardMain.innerHTML = overallPerfCardHTML + insightsCardHTML + exitAnalysisWidgetsHTML + comparisonSectionContainer + accountGridContainer;

                generateAndRenderSmartInsights();
                renderDashboardExitAnalysisWidgets();

                const dashboardGrid = document.getElementById('dashboard-grid-content'); // re-acquire after innerHTML change
                renderComparisonSection();

                currentUser.accounts.forEach(account => {
                    const performance = getPerformanceStatus(account.equity, account.allocatedFunds);
                    
                    const totalTrades = account.trades.length;
                    const recentTrades = account.trades.slice(-30);
                    const disciplinedTradesForScore = recentTrades.filter(t => t.stopLossUsed === 'Yes' && (!t.mistakes || t.mistakes.length === 0)).length;
                    const totalTradesForScore = recentTrades.length;
                    const disciplineScore = totalTradesForScore > 0 ? (disciplinedTradesForScore / totalTradesForScore) * 100 : 100;
                    const totalMistakes = account.trades.reduce((sum, trade) => sum + (trade.mistakes ? trade.mistakes.length : 0), 0);
                    const netProfit = account.equity - account.allocatedFunds;

                    dashboardGrid.innerHTML += `
                        <div class="card account-card" data-id="${account.id}">
                             <div class="account-card-actions">
                                <button class="action-btn edit-btn" data-id="${account.id}" title="Edit Account">${icons.edit}</button>
                                <button class="action-btn delete-btn" data-id="${account.id}" title="Move to Trash">${icons.delete}</button>
                            </div>
                            <div class="account-card-header">
                                <h3 style="padding-right: 0.5rem;">${account.name}</h3>
                                <div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                    <span class="phase-badge">Phase: ${account.phase || 'Demo'}</span>
                                    <div class="status-dot ${performance}"></div>
                                </div>
                            </div>
                            <div class="account-card-body" style="display:flex; justify-content: space-between; gap: 1rem; margin-top: 1.5rem;">
                                <div class="metric"><div><p class="metric-value ${netProfit >= 0 ? 'pnl-profit' : 'pnl-loss'}">${formatCurrency(netProfit)}</p><p class="metric-label">Net Profit</p></div></div>
                                <div class="metric"><div><p class="metric-value">${formatCurrency(account.equity)}</p><p class="metric-label">Equity</p></div></div>
                            </div>
                            <div class="account-card-stats" style="margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                                <div style="margin-bottom: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Discipline Score</span>
                                        <span style="font-weight: 600;">${disciplineScore.toFixed(0)}%</span>
                                    </div>
                                    <div class="progress-bar-container" style="height: 8px;"><div class="progress-bar" style="width: ${disciplineScore}%;"></div></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Total Mistakes:</span>
                                        <span style="font-weight: 600; color: ${totalMistakes > 0 ? 'var(--status-bad)' : 'var(--status-good)'};">${totalMistakes}</span>
                                    </div>
                                    <div>
                                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Total Trades:</span>
                                        <span style="font-weight: 600;">${totalTrades}</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });

                dashboardGrid.innerHTML += `
                    <div class="card add-account-card" id="add-account-btn">
                        <div class="add-icon">${icons.add}</div><h3 style="font-weight: 600;">Add New Account</h3>
                    </div>`;
            };

            const renderAccountDetail = (accountId) => {
                const isDeleted = currentUser.deletedAccounts && currentUser.deletedAccounts.some(acc => acc.id === accountId);
                const account = isDeleted 
                    ? currentUser.deletedAccounts.find(acc => acc.id === accountId)
                    : currentUser.accounts.find(acc => acc.id === accountId);

                if (!account) return;

                // Loss Limit Breach visual indicator
                let lossLimitBannerHTML = '';
                if (!isDeleted && account.lossLimit) {
                    const lossLimitThreshold = account.allocatedFunds * (1 - (account.lossLimit / 100));
                    if (account.equity <= lossLimitThreshold) {
                        lossLimitBannerHTML = `
                            <div class="card" style="background-color: var(--status-bad-bg); border-color: var(--status-bad); color: var(--text-primary); margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <div style="display:flex; align-items:center; gap: 1rem;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--status-bad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                                    <div>
                                        <h4 style="font-weight: 700;">Loss Limit Breached</h4>
                                        <p style="font-size: 0.9rem; color: var(--text-secondary);">This account's equity (${formatCurrency(account.equity)}) is below the loss limit threshold of ${formatCurrency(lossLimitThreshold)}.</p>
                                    </div>
                                </div>
                                <button id="breach-move-to-trash" class="trash-action-btn perm-delete" style="flex-shrink: 0;">Move to Trash</button>
                            </div>
                        `;
                    }
                }

                let currentPage = 1;
                let itemsPerPage = 10;
                
                const netProfit = account.equity - account.allocatedFunds;
                const pnlPercent = account.allocatedFunds !== 0 ? (netProfit / account.allocatedFunds) * 100 : 0;
                const totalTrades = account.trades.length;
                const winningTrades = account.trades.filter(t => t.pnl > 0).length;
                const losingTrades = totalTrades - winningTrades;
                const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;
                
                const creationDate = new Date(account.creationDate);
                const today = new Date();
                const utcCreation = Date.UTC(creationDate.getFullYear(), creationDate.getMonth(), creationDate.getDate());
                const utcToday = Date.UTC(today.getFullYear(), today.getMonth(), today.getDate());
                const accountAge = Math.floor((utcToday - utcCreation) / (1000 * 60 * 60 * 24)) + 1;
                
                const uniqueTradeDays = new Set(account.trades.map(t => new Date(t.date).toLocaleDateString()));
                const daysActive = uniqueTradeDays.size;

                const performance = getPerformanceStatus(account.equity, account.allocatedFunds);
                const equityChartSVG = generateEquityChartSVG(account);

                const mistakeOptions = ["Overtrading", "Late Entry", "Early Exit", "No Stop Loss", "Ignored Setup"];
                const mistakeCheckboxesHTML = mistakeOptions.map(mistake => `
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; background-color: var(--bg-primary); padding: 0.5rem 0.75rem; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer;">
                        <input type="checkbox" name="mistake" value="${mistake}" style="width: auto; accent-color: var(--accent-cyan);"> ${mistake}
                    </label>
                `).join('');
                
                const tradeJournalHTML = isDeleted 
                    ? `<p style="color: var(--status-bad); text-align: center; margin-bottom: 1rem; padding: 1rem; background-color: var(--status-bad-bg); border-radius: 8px;">This account is in the trash. You can review its history, but you cannot add new trades or withdrawals.</p>`
                    : `<form id="trade-form" class="trade-journal-form"><div class="form-group"><label for="tradePair">Pair/Symbol</label><input type="text" id="tradePair" required></div><div class="form-group"><label for="tradeType">Type</label><select id="tradeType"><option value="Buy">Buy</option><option value="Sell">Sell</option></select></div><div class="form-group"><label for="tradeLot">Lot Size</label><input type="number" step="0.01" id="tradeLot" required></div><div class="form-group"><label for="tradeEntry">Entry</label><input type="number" step="any" id="tradeEntry" required></div><div class="form-group"><label for="tradeExit">Exit</label><input type="number" step="any" id="tradeExit" required></div><div class="form-group"><label for="tradePnl">P/L ($)</label><input type="number" step="any" id="tradePnl" required></div><div class="form-group"><label for="tradePlannedRR">Planned R:R</label><input type="number" step="any" id="tradePlannedRR" min="0" required></div><div class="form-group"><label for="tradeActualRR">Actual R:R</label><input type="number" step="any" id="tradeActualRR" required></div><div class="form-group"><label for="tradeRiskPercent">Risk %</label><input type="number" step="any" id="tradeRiskPercent" min="0" required></div><div class="form-group"><label for="tradeStopLossUsed">Stop Loss Used</label><select id="tradeStopLossUsed" required><option value="Yes">Yes</option><option value="No">No</option></select></div><div class="form-group"><label for="tradeSession">Trading Session</label><select id="tradeSession" required><option value="" disabled selected>Select Session</option><option value="Asian">Asian</option><option value="London">London</option><option value="New York">New York</option><option value="Sydney">Sydney</option></select></div>
                    <div class="form-group"><label for="tradeTimeFrame">Chart Time Frame</label><select id="tradeTimeFrame" required><option value="" disabled selected>Select TF</option><option value="1m">1m</option><option value="5m">5m</option><option value="15m">15m</option><option value="30m">30m</option><option value="1H">1H</option><option value="4H">4H</option><option value="Daily">Daily</option><option value="Weekly">Weekly</option></select></div>
                    <div class="form-group"><label for="tradeMood">Mood</label><select id="tradeMood" required><option value="" disabled selected>Select Mood</option><option value="Calm">Calm</option><option value="Confident">Confident</option><option value="Focused">Focused</option><option value="Anxious">Anxious</option><option value="Fearful">Fearful</option><option value="Greedy">Greedy</option><option value="Overthinking">Overthinking</option></select></div>
                    <div class="form-group"><label for="tradeEntryReasonSelect">Entry Reason</label><select id="tradeEntryReasonSelect" required><option value="" disabled selected>Select Reason</option><option value="ICT Setup">ICT Setup</option><option value="Custom Setup">Manual Setup Name</option><option value="FOMO Entry">FOMO Entry</option><option value="Revenge Entry">Revenge Entry</option><option value="Overconfidence">Overconfidence</option><option value="News Driven">News Driven</option></select><select id="tradeIctSetupSelect" style="display: none; margin-top: 0.5rem;"><option>Breaker</option><option>FVG</option><option>Order Block</option><option>Liquidity Grab</option><option>Turtle Soup</option></select><input type="text" id="tradeEntryReasonOther" placeholder="e.g., Head and Shoulders" style="display: none; margin-top: 0.5rem;" list="custom-setups"/><datalist id="custom-setups"></datalist></div>
                    <div class="form-group"><label for="tradeExitReasonSelect">Exit Reason</label><select id="tradeExitReasonSelect"><option value="Take Profit Hit">Take Profit Hit</option><option value="Stop Loss Hit">Stop Loss Hit</option><option value="Fear Exit">Fear Exit</option><option value="Greed Exit">Greed Exit</option><option value="Time Exit">Time Exit</option><option value="Trailing SL">Trailing SL</option><option value="Partial Close">Partial Close</option><option value="Other">Other</option></select><input type="text" id="tradeExitReasonOther" placeholder="Specify exit reason" style="display: none; margin-top: 0.5rem;"/></div>
                    <div class="form-group"><label for="tradeAfterExitMove">After Exit Market Move</label><select id="tradeAfterExitMove" required><option value="" disabled selected>Select Outcome</option><option value="Continued in Same Direction">Continued in Same Direction</option><option value="Reversed Immediately">Reversed Immediately</option><option value="Went Slightly in Same Direction then Reversed">Went Slightly, then Reversed</option><option value="Consolidated (No Major Move)">Consolidated</option></select></div><div class="form-group full-span"><label for="tradeNotes">Notes</label><textarea id="tradeNotes"></textarea></div><div class="form-group full-span"><label>Mistake Tags (if any)</label><div id="tradeMistakes" style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 0.5rem;">${mistakeCheckboxesHTML}</div></div><div class="form-group full-span"><label for="tradeAttachment">Attachment</label><div class="file-input-wrapper"><span>Choose File</span><span id="file-name" class="file-name"></span><input type="file" id="tradeAttachment" accept="image/*,application/pdf"></div></div><button type="submit" class="add-trade-button">Add Trade</button></form>`;
                
                const accountHeaderHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <h2 style="font-size: 1.75rem; font-weight: 700;">${account.name}</h2>
                            <span class="phase-badge" style="font-size: 0.9rem; padding: 0.4rem 0.8rem; margin-top: 0.5rem;">Phase: ${account.phase || 'Demo'}</span>
                        </div>
                        <div class="status-dot ${performance}"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; align-items: center;">
                        <div class="metric">
                            <div class="metric-icon">${icons.profit}</div>
                            <div><p class="metric-value ${netProfit >= 0 ? 'pnl-profit' : 'pnl-loss'}">${formatCurrency(netProfit)}</p><p class="metric-label">Net Profit</p></div>
                        </div>
                        <div class="metric">
                            <div class="metric-icon">${icons.equity}</div>
                            <div><p class="metric-value">${formatCurrency(account.equity)}</p><p class="metric-label">Equity</p></div>
                        </div>
                        ${!isDeleted ? `<button id="add-withdrawal-btn" class="modal-submit" style="grid-column: auto; margin: 0; padding: 0.75rem 1.25rem; height: fit-content;">Add Withdrawal</button>` : ''}
                    </div>
                `;

                accountDetailView.innerHTML = `
                    <button id="back-to-dashboard" class="back-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>All Accounts</button>
                    ${lossLimitBannerHTML}
                    <header class="card" style="margin-bottom: 2rem;">${accountHeaderHTML}</header>
                    <div class="detail-grid"><div class="stat-card"><h4 class="stat-card-title">${icons.stats} Performance</h4><div class="metric-group"><div><div class="stat-card-value ${pnlPercent >= 0 ? 'pnl-profit' : 'pnl-loss'}">${pnlPercent.toFixed(2)}%</div><div class="metric-label">P/L</div></div></div><div class="metric-group"><div><div class="stat-card-value">${winRate.toFixed(1)}%</div><div class="metric-label">Win Rate</div></div></div></div><div class="stat-card"><h4 class="stat-card-title">${icons.trades} Summary</h4><div class="metric-group"><div><div class="stat-card-value">${totalTrades}</div><div class="metric-label">Total Trades</div></div></div><div class="metric-group"><div><div class="stat-card-value pnl-profit">${winningTrades}</div><div class="metric-label">Winning</div></div></div><div class="metric-group"><div><div class="stat-card-value pnl-loss">${losingTrades}</div><div class="metric-label">Losing</div></div></div></div><div class="stat-card"><h4 class="stat-card-title">${icons.calendar} Account Timeline</h4><div class="metric-group"><div><div class="stat-card-value">${accountAge}</div><div class="metric-label">Account Age (Days)</div></div></div><div class="metric-group"><div><div class="stat-card-value">${daysActive}</div><div class="metric-label">Active Trading Days</div></div></div></div><div class="stat-card"><h4 class="stat-card-title">${icons.chart} Equity</h4>${equityChartSVG}</div></div>
                    
                    <section class="card"><h3 class="section-title">Trade Journal</h3>${tradeJournalHTML}</section>
                    
                    <section class="card" style="margin-top: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem;">
                            <h3 class="section-title" style="border: none; margin: 0; padding: 0;">Trade History</h3>
                            <div class="form-group" style="margin-bottom: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <label for="items-per-page-select" style="margin-bottom: 0; color: var(--text-secondary); font-size: 0.875rem; font-weight: 500;">Show last:</label>
                                <select id="items-per-page-select" class="form-group" style="padding: 0.5rem 0.75rem; margin-bottom: 0; width: auto;">
                                    <option value="10">10 trades</option>
                                    <option value="20">20 trades</option>
                                    <option value="50">50 trades</option>
                                </select>
                            </div>
                        </div>
                        <div id="trade-log-filters-container"></div>
                        <div id="trade-log-container" class="trade-log-container"></div>
                        <div id="trade-log-pagination-controls" style="padding-top: 1.5rem; border-top: 1px solid var(--border-color); margin-top: 1.5rem; min-height: 38px;"></div>
                    </section>

                    <section id="performance-analyzer-section" class="card" style="margin-top: 2rem;"></section>
                `;
                
                const breachButton = accountDetailView.querySelector('#breach-move-to-trash');
                if (breachButton) {
                    breachButton.addEventListener('click', () => {
                        if (handleSoftDeleteAccount(accountId)) {
                            switchView(dashboardView);
                        }
                    });
                }
                
                accountDetailView.querySelector('#back-to-dashboard').addEventListener('click', () => {
                    const fromTrash = currentUser.deletedAccounts.some(acc => acc.id === accountId);
                    if (fromTrash) {
                        renderTrashView();
                        switchView(trashView);
                    } else {
                        switchView(dashboardView);
                    }
                });
                
                if (!isDeleted) {
                    accountDetailView.querySelector('#add-withdrawal-btn')?.addEventListener('click', () => openWithdrawalModal(accountId));
                    const tradeForm = accountDetailView.querySelector('#trade-form');
                    tradeForm.addEventListener('submit', (e) => handleAddTrade(e, accountId));
                    
                    const entryReasonSelect = tradeForm.querySelector('#tradeEntryReasonSelect');
                    const ictSetupSelect = tradeForm.querySelector('#tradeIctSetupSelect');
                    const customSetupInput = tradeForm.querySelector('#tradeEntryReasonOther');
                    const customSetupsDatalist = tradeForm.querySelector('#custom-setups');

                    if (currentUser.customEntryReasons) {
                        customSetupsDatalist.innerHTML = currentUser.customEntryReasons.map(r => `<option value="${r}"></option>`).join('');
                    }

                    entryReasonSelect.addEventListener('change', () => {
                        ictSetupSelect.style.display = entryReasonSelect.value === 'ICT Setup' ? 'block' : 'none';
                        customSetupInput.style.display = entryReasonSelect.value === 'Custom Setup' ? 'block' : 'none';
                    });

                    const exitReasonSelect = tradeForm.querySelector('#tradeExitReasonSelect');
                    const exitReasonOther = tradeForm.querySelector('#tradeExitReasonOther');
                    exitReasonSelect.addEventListener('change', () => {
                        exitReasonOther.style.display = exitReasonSelect.value === 'Other' ? 'block' : 'none';
                    });

                    tradeForm.querySelector('#tradeAttachment').addEventListener('change', (e) => {
                        const fileName = e.target.files.length > 0 ? e.target.files[0].name : '';
                        accountDetailView.querySelector('#file-name').textContent = fileName;
                    });
                    
                    const tradePnlInput = tradeForm.querySelector('#tradePnl');
                    const tradeActualRRInput = tradeForm.querySelector('#tradeActualRR');
                    tradePnlInput.addEventListener('input', () => {
                        const pnlValue = parseFloat(tradePnlInput.value);
                        if (isNaN(pnlValue)) {
                            tradeActualRRInput.removeAttribute('min');
                            tradeActualRRInput.removeAttribute('max');
                            return;
                        }
                        if (pnlValue < 0) { // Loss
                            tradeActualRRInput.setAttribute('max', '0');
                            tradeActualRRInput.removeAttribute('min');
                            if (parseFloat(tradeActualRRInput.value) > 0) {
                                tradeActualRRInput.value = '';
                            }
                        } else { // Profit or Break-even
                            tradeActualRRInput.setAttribute('min', '0');
                            tradeActualRRInput.removeAttribute('max');
                            if (parseFloat(tradeActualRRInput.value) < 0) {
                                tradeActualRRInput.value = '';
                            }
                        }
                    });
                }

                const applyFilters = () => {
                    const currentFilters = { 
                        fromDate: accountDetailView.querySelector('#filterFromDate')?.value,
                        toDate: accountDetailView.querySelector('#filterToDate')?.value,
                        pairFilter: accountDetailView.querySelector('#filterPair')?.value,
                        typeFilter: accountDetailView.querySelector('#filterType')?.value,
                        sessionFilter: accountDetailView.querySelector('#filterSession')?.value,
                        timeFrameFilter: accountDetailView.querySelector('#filterTimeFrame')?.value,
                        moodFilter: accountDetailView.querySelector('#filterMood')?.value,
                        entryFilter: accountDetailView.querySelector('#filterEntryReason')?.value, 
                        exitFilter: accountDetailView.querySelector('#filterExitReason')?.value,
                        mistakeFilter: accountDetailView.querySelector('#filterMistake')?.value
                    };
                    const filteredTrades = getFilteredTrades(account, currentFilters);
                    renderTradeLog(account, filteredTrades);
                    renderPerformanceAnalyzer(account, filteredTrades);
                };

                if (account.trades.length > 0) {
                    const tradeLogFiltersContainer = accountDetailView.querySelector('#trade-log-filters-container');
                    const filterSectionHTML = `
                        <form id="trade-log-filters" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; align-items: flex-end; margin-bottom: 1.5rem;">
                            <h4 style="font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); grid-column: 1 / -1; margin-bottom: 0.5rem;">Filter Trades</h4>
                            <div class="form-group" style="margin-bottom: 0;"><label for="filterFromDate">From Date</label><input type="date" id="filterFromDate"></div>
                            <div class="form-group" style="margin-bottom: 0;"><label for="filterToDate">To Date</label><input type="date" id="filterToDate"></div>
                            <div class="form-group" style="margin-bottom: 0;"><label for="filterPair">Pair/Symbol</label><select id="filterPair"></select></div>
                            <div class="form-group" style="margin-bottom: 0;"><label for="filterType">Type</label><select id="filterType"></select></div>
                            <div class="form-group" style="margin-bottom: 0;"><label for="filterSession">Session</label><select id="filterSession"></select></div>
                            <div class="form-group" style="margin-bottom: 0;"><label for="filterTimeFrame">Time Frame</label><select id="filterTimeFrame"></select></div>
                            <div class="form-group" style="margin-bottom: 0;"><label for="filterMood">Mood</label><select id="filterMood"></select></div>
                            <div class="form-group" style="margin-bottom: 0;"><label for="filterEntryReason">Entry Reason</label><select id="filterEntryReason"></select></div>
                            <div class="form-group" style="margin-bottom: 0;"><label for="filterExitReason">Exit Reason</label><select id="filterExitReason"></select></div>
                            <div class="form-group" style="margin-bottom: 0;"><label for="filterMistake">Mistake Tag</label><select id="filterMistake"></select></div>
                            <button type="button" id="clear-filters-btn" class="back-button" style="margin: 0; padding: 0.75rem 1.25rem; height: fit-content;">Clear Filters</button>
                        </form>`;
                    tradeLogFiltersContainer.innerHTML = filterSectionHTML;

                    const filterFromDate = accountDetailView.querySelector('#filterFromDate');
                    const filterToDate = accountDetailView.querySelector('#filterToDate');
                    const filterPairSelect = accountDetailView.querySelector('#filterPair');
                    const filterTypeSelect = accountDetailView.querySelector('#filterType');
                    const filterSessionSelect = accountDetailView.querySelector('#filterSession');
                    const filterTimeFrameSelect = accountDetailView.querySelector('#filterTimeFrame');
                    const filterMoodSelect = accountDetailView.querySelector('#filterMood');
                    const filterEntryReasonSelect = accountDetailView.querySelector('#filterEntryReason');
                    const filterExitReasonSelect = accountDetailView.querySelector('#filterExitReason');
                    const filterMistakeSelect = accountDetailView.querySelector('#filterMistake');
                    const clearFiltersBtn = accountDetailView.querySelector('#clear-filters-btn');

                    const uniquePairs = ['All', ...new Set(account.trades.map(t => t.pair).filter(Boolean))];
                    const uniqueTypes = ['All', 'Buy', 'Sell'];
                    const uniqueSessions = ['All', ...new Set(account.trades.map(t => t.session).filter(Boolean))];
                    const uniqueTimeFrames = ['All', ...new Set(account.trades.map(t => t.timeFrame).filter(Boolean))];
                    const uniqueMoods = ['All', ...new Set(account.trades.map(t => t.mood).filter(Boolean))];
                    const uniqueEntryReasons = ['All', ...new Set(account.trades.map(t => t.entryReason).filter(Boolean))];
                    const uniqueExitReasons = ['All', ...new Set(account.trades.map(t => t.exitReason).filter(Boolean))];
                    const uniqueMistakes = ['All', ...new Set(account.trades.flatMap(t => t.mistakes || []).filter(Boolean))];

                    filterPairSelect.innerHTML = uniquePairs.map(p => `<option value="${p}">${p}</option>`).join('');
                    filterTypeSelect.innerHTML = uniqueTypes.map(t => `<option value="${t}">${t}</option>`).join('');
                    filterSessionSelect.innerHTML = uniqueSessions.map(s => `<option value="${s}">${s}</option>`).join('');
                    filterTimeFrameSelect.innerHTML = uniqueTimeFrames.map(tf => `<option value="${tf}">${tf}</option>`).join('');
                    filterMoodSelect.innerHTML = uniqueMoods.map(m => `<option value="${m}">${m}</option>`).join('');
                    filterEntryReasonSelect.innerHTML = uniqueEntryReasons.map(r => `<option value="${r}">${r}</option>`).join('');
                    filterExitReasonSelect.innerHTML = uniqueExitReasons.map(r => `<option value="${r}">${r}</option>`).join('');
                    filterMistakeSelect.innerHTML = uniqueMistakes.map(m => `<option value="${m}">${m}</option>`).join('');
                    
                    const itemsPerPageSelect = accountDetailView.querySelector('#items-per-page-select');
                    itemsPerPageSelect.addEventListener('change', (e) => {
                        itemsPerPage = parseInt(e.target.value, 10);
                        currentPage = 1;
                        applyFilters();
                    });

                    const resetAndApplyFilters = () => {
                        currentPage = 1;
                        applyFilters();
                    };

                    filterFromDate.addEventListener('change', resetAndApplyFilters);
                    filterToDate.addEventListener('change', resetAndApplyFilters);
                    filterPairSelect.addEventListener('change', resetAndApplyFilters);
                    filterTypeSelect.addEventListener('change', resetAndApplyFilters);
                    filterSessionSelect.addEventListener('change', resetAndApplyFilters);
                    filterTimeFrameSelect.addEventListener('change', resetAndApplyFilters);
                    filterMoodSelect.addEventListener('change', resetAndApplyFilters);
                    filterEntryReasonSelect.addEventListener('change', resetAndApplyFilters);
                    filterExitReasonSelect.addEventListener('change', resetAndApplyFilters);
                    filterMistakeSelect.addEventListener('change', resetAndApplyFilters);
                    clearFiltersBtn.addEventListener('click', () => {
                        accountDetailView.querySelector('#trade-log-filters').reset();
                        filterPairSelect.value = 'All';
                        filterTypeSelect.value = 'All';
                        filterSessionSelect.value = 'All';
                        filterTimeFrameSelect.value = 'All';
                        filterMoodSelect.value = 'All';
                        filterEntryReasonSelect.value = 'All';
                        filterExitReasonSelect.value = 'All';
                        filterMistakeSelect.value = 'All';
                        resetAndApplyFilters();
                    });
                }
                
                const renderTradeLog = (account, tradesToDisplay) => {
                    const container = accountDetailView.querySelector('#trade-log-container');
                    const paginationContainer = accountDetailView.querySelector('#trade-log-pagination-controls');

                    const totalFilteredTrades = tradesToDisplay.length;
                    const reversedTrades = [...tradesToDisplay].reverse();
                    const startIndex = (currentPage - 1) * itemsPerPage;
                    const paginatedTrades = reversedTrades.slice(startIndex, startIndex + itemsPerPage);

                    let contentHTML = `<h4 style="font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 1.5rem;">Total Trades Found: ${totalFilteredTrades}</h4>`;

                    if (paginatedTrades.length === 0) {
                        const message = account.trades.length === 0 ? 'No trades logged yet.' : 'No trades match the current filters.';
                        contentHTML += `<p style="text-align:center; color: var(--text-secondary); margin-top: 2rem;">${message}</p>`;
                        paginationContainer.innerHTML = '';
                        container.innerHTML = contentHTML;
                        return;
                    }

                    const getRrColorClass = (value) => {
                        if (value === null || typeof value === 'undefined') return '';
                        if (value <= 1) return 'pnl-loss';
                        if (value >= 3) return 'pnl-profit';
                        if (value > 1 && value < 3) return 'pnl-avg';
                        return '';
                    };
                    const getRiskColorClass = (value) => {
                        if (value === null || typeof value === 'undefined') return '';
                        if (value <= 1) return 'pnl-profit';
                        if (value > 1 && value <= 3) return 'pnl-avg';
                        if (value > 3) return 'pnl-loss';
                        return '';
                    };

                    const handleAttachmentClick = (e, trade) => {
                        e.preventDefault();
                        if (!trade.attachment) return;

                        const isDataUrl = trade.attachment.startsWith('data:');
                        if (isDataUrl) {
                            const [header, body] = trade.attachment.split(',');
                            const mime = header.match(/:(.*?);/)[1];
                            const byteCharacters = atob(body);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: mime });

                            const url = URL.createObjectURL(blob);
                            
                            const supportedPreviewTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
                            if (supportedPreviewTypes.includes(mime)) {
                                window.open(url, '_blank');
                            } else {
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = trade.attachmentName || `attachment-${trade.id}`;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                            }
                        } else {
                             window.open(trade.attachment, '_blank');
                        }
                    };

                    const tableRows = paginatedTrades.map((trade, index) => `<tr><td>${startIndex + index + 1}</td><td>${new Date(trade.date).toLocaleDateString()}</td><td>${trade.pair}</td><td>${trade.type}</td><td>${trade.lot}</td><td>${trade.entry}</td><td>${trade.exit}</td><td class="${trade.pnl >= 0 ? 'pnl-profit' : 'pnl-loss'}">${formatCurrency(trade.pnl)}</td><td class="${getRrColorClass(trade.plannedRR)}">${trade.plannedRR || ''}</td><td class="${getRrColorClass(trade.actualRR)}">${trade.actualRR || ''}</td><td class="${getRiskColorClass(trade.riskPercent)}">${trade.riskPercent ? `${trade.riskPercent}%` : ''}</td><td>${trade.stopLossUsed || ''}</td><td>${trade.session || ''}</td><td>${trade.timeFrame || ''}</td><td>${trade.mood || ''}</td><td>${trade.entryReason || ''}</td><td>${trade.exitReason || ''}</td><td>${(trade.mistakes && trade.mistakes.length > 0) ? trade.mistakes.map(m => `<span class="mistake-tag">${m}</span>`).join('') : ''}</td><td>${renderNoteCell(trade.notes, trade.id)}</td><td>${trade.afterExitMove || ''}</td><td>${trade.attachment ? `<a href="#" class="attachment-link" data-trade-id="${trade.id}" title="View Attachment">${icons.clip}</a>` : ''}</td></tr>`).join('');
                    
                    contentHTML += `<table class="trade-log-table" style="margin-top: 0;"><thead><tr><th>#</th><th>Date</th><th>Pair</th><th>Type</th><th>Lot</th><th>Entry</th><th>Exit</th><th>P/L</th><th>Planned R:R</th><th>Actual R:R</th><th>Risk %</th><th>SL Used</th><th>Session</th><th>Time Frame</th><th>Mood</th><th>Entry Reason</th><th>Exit Reason</th><th>Mistakes</th><th>Notes</th><th>Post-Exit Move</th><th>Attachment</th></tr></thead><tbody>${tableRows}</tbody></table>`;
                    
                    container.innerHTML = contentHTML;
                
                    container.querySelectorAll('.attachment-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            const tradeId = parseInt(link.dataset.tradeId);
                            const trade = account.trades.find(t => t.id === tradeId);
                            if (trade) handleAttachmentClick(e, trade);
                        });
                    });

                    container.querySelectorAll('.read-more-note').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const tradeId = parseInt(link.dataset.tradeId);
                            const trade = account.trades.find(t => t.id === tradeId);
                            if (trade && trade.notes) {
                                document.getElementById('note-modal-content').textContent = trade.notes;
                                noteModal.classList.add('visible');
                            }
                        });
                    });

                    // Pagination Controls
                    const totalPages = Math.ceil(totalFilteredTrades / itemsPerPage);
                    let paginationHTML = '';
                    if (totalPages > 1) {
                        paginationHTML = `<div style="display: flex; justify-content: space-between; align-items: center; max-width: 300px; margin: 0 auto;">`;
                        paginationHTML += `<button id="prev-page-btn" class="back-button" style="margin: 0;" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
                        paginationHTML += `<span style="color: var(--text-secondary); font-size: 0.9rem;">Page ${currentPage} of ${totalPages}</span>`;
                        paginationHTML += `<button id="next-page-btn" class="back-button" style="margin: 0;" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
                        paginationHTML += `</div>`;
                    }
                    paginationContainer.innerHTML = paginationHTML;

                    paginationContainer.querySelector('#prev-page-btn')?.addEventListener('click', () => {
                        currentPage--;
                        applyFilters();
                    });
                    paginationContainer.querySelector('#next-page-btn')?.addEventListener('click', () => {
                        currentPage++;
                        applyFilters();
                    });
                };
                
                applyFilters();
                switchView(accountDetailView);
            };

            const renderNoteCell = (note, tradeId) => {
                if (!note || note.trim() === '') return '';

                const words = note.trim().split(/\s+/);
                const TRUNCATE_LIMIT = 7;

                if (words.length > TRUNCATE_LIMIT) {
                    const shortNote = words.slice(0, TRUNCATE_LIMIT).join(' ');
                    return `${shortNote} <a href="#" class="read-more-note" data-trade-id="${tradeId}" style="color: var(--accent-cyan); text-decoration: none; font-weight: 500;">...more</a>`;
                } else {
                    return note;
                }
            };
            
            const generateReasonPieChartSVG = (data, title, customColors = {}) => {
                const defaultColors = ['#58A6FF', '#39C5CF', '#A371F7', '#D29922', '#DA3633', '#238636', '#8B949E'];
                const entries = Object.entries(data).filter(([, value]) => value > 0).sort(([,a],[,b]) => b-a);
                const total = entries.reduce((sum, [, value]) => sum + value, 0);
                if (total === 0) return `<div style="height:200px; width:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color: var(--text-secondary);"><h5 style="margin: 0 0 1rem 0; font-size: 1rem; color: var(--text-primary); text-align: center;">${title}</h5>No data available.</div>`;

                const cx = 100, cy = 100, r = 80;
                let startAngle = -90;
                let paths = '';
                let legend = '';

                entries.forEach(([key, value], index) => {
                    const percent = value / total;
                    const angle = percent * 360;
                    const endAngle = startAngle + angle;
                    const x1 = cx + r * Math.cos(startAngle * Math.PI / 180);
                    const y1 = cy + r * Math.sin(startAngle * Math.PI / 180);
                    const x2 = cx + r * Math.cos(endAngle * Math.PI / 180);
                    const y2 = cy + r * Math.sin(endAngle * Math.PI / 180);
                    const largeArcFlag = angle > 180 ? 1 : 0;
                    const d = `M ${cx},${cy} L ${x1},${y1} A ${r},${r} 0 ${largeArcFlag},1 ${x2},${y2} Z`;
                    const color = customColors[key] || defaultColors[index % defaultColors.length];
                    paths += `<path d="${d}" fill="${color}" />`;
                    legend += `<div style="display: flex; align-items: center; font-size: 0.8rem; margin-bottom: 0.25rem;"><div style="width: 12px; height: 12px; background-color: ${color}; border-radius: 3px; margin-right: 8px;"></div><div>${key} (${((value/total)*100).toFixed(0)}%)</div></div>`;
                    startAngle = endAngle;
                });

                return `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                        <h5 style="margin: 0; font-size: 1rem; color: var(--text-primary); text-align: center;">${title}</h5>
                        <div class="pie-chart-layout" style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap; justify-content: center;">
                            <svg viewBox="0 0 200 200" width="150" height="150">${paths}</svg>
                            <div style="max-width: 200px;">${legend}</div>
                        </div>
                    </div>`;
            };

            const renderMistakeAnalysisContent = (mistakeStats) => {
                const contentContainer = document.getElementById('mistake-list-content');
                if (!contentContainer) return;

                const sortedMistakes = Object.entries(mistakeStats).sort(([, a], [, b]) => b - a);
                let isExpanded = false;

                const render = () => {
                    if (sortedMistakes.length === 0) {
                        contentContainer.innerHTML = `<div style="flex-grow: 1; display: flex; align-items: center; justify-content: center;"><p class="metric-label">No mistakes tagged yet.</p></div>`;
                        return;
                    }

                    const mistakesToShow = isExpanded ? sortedMistakes : sortedMistakes.slice(0, 4);
                    
                    let listHTML = `<div style="flex-grow: 1;">${mistakesToShow.map(([mistake, count]) => `
                        <div class="metric-group" style="padding-bottom: 0.75rem;">
                            <div>
                                <div class="stat-card-value" style="font-size: 1.25rem;">${count}</div>
                                <div class="metric-label">${mistake}</div>
                            </div>
                        </div>`).join('')}</div>`;
                    
                    let toggleHTML = '';
                    if (sortedMistakes.length > 4) {
                        toggleHTML = `
                            <div style="text-align: right; margin-top: auto; padding-top: 0.5rem;">
                                <a href="#" id="mistake-toggle-btn" style="color: var(--accent-cyan); text-decoration: none; font-weight: 500; font-size: 0.9rem;">
                                    ${isExpanded ? 'Less' : 'More...'}
                                </a>
                            </div>`;
                    }
                    
                    contentContainer.innerHTML = listHTML + toggleHTML;

                    if (sortedMistakes.length > 4) {
                        const toggleBtn = contentContainer.querySelector('#mistake-toggle-btn');
                        if (toggleBtn) {
                            toggleBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                isExpanded = !isExpanded;
                                render();
                            });
                        }
                    }
                };

                render(); // Initial render
            };

            const renderPerformanceAnalyzer = (account, tradesToAnalyze) => {
                const container = document.getElementById('performance-analyzer-section');
                if (!container) return;
                
                if (!account.trades || account.trades.length === 0) {
                    container.innerHTML = `<h3 class="section-title">Performance & Discipline Analyzer</h3><p style="text-align:center; color: var(--text-secondary); margin-top: 1rem;">Log some trades to see your performance analysis.</p>`;
                    return;
                }
                
                const trades = tradesToAnalyze;
                if (!trades || trades.length === 0) {
                     container.innerHTML = `<h3 class="section-title">Performance & Discipline Analyzer</h3><p style="text-align:center; color: var(--text-secondary); margin-top: 1rem;">No trades match the current filters.</p>`;
                    return;
                }

                // --- CALCULATIONS ---
                const totalTrades = trades.length;
                const winningTrades = trades.filter(t => t.pnl > 0).length;
                const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;
                const totalPnl = trades.reduce((sum, t) => sum + t.pnl, 0);
                const avgPnl = totalTrades > 0 ? totalPnl / totalTrades : 0;
                const bestTrade = trades.length > 0 ? Math.max(...trades.map(t => t.pnl)) : 0;
                const worstTrade = trades.length > 0 ? Math.min(...trades.map(t => t.pnl)) : 0;

                const typeStats = {
                    Buy: { pnl: 0, wins: 0, total: 0 },
                    Sell: { pnl: 0, wins: 0, total: 0 }
                };

                const slUsed = trades.filter(t => t.stopLossUsed === 'Yes').length;
                const slUsedPercent = totalTrades > 0 ? (slUsed / totalTrades) * 100 : 0;

                const applicableRRTrades = trades.filter(t => typeof t.plannedRR === 'number' && typeof t.actualRR === 'number');
                const rrPlanFollowed = applicableRRTrades.filter(t => t.actualRR >= t.plannedRR).length;
                const rrPlanFollowedPercent = applicableRRTrades.length > 0 ? (rrPlanFollowed / applicableRRTrades.length) * 100 : 0;

                const validPlannedRRTrades = trades.filter(t => typeof t.plannedRR === 'number');
                const avgPlannedRR = validPlannedRRTrades.length > 0 ? validPlannedRRTrades.reduce((sum, t) => sum + t.plannedRR, 0) / validPlannedRRTrades.length : 0;
                const validActualRRTrades = trades.filter(t => typeof t.actualRR === 'number');
                const avgActualRR = validActualRRTrades.length > 0 ? validActualRRTrades.reduce((sum, t) => sum + t.actualRR, 0) / validActualRRTrades.length : 0;
                
                const sessions = ["Asian", "London", "New York", "Sydney"];
                const sessionStats = sessions.reduce((acc, session) => ({ ...acc, [session]: { pnl: 0, wins: 0, total: 0 } }), {});
                
                const entryReasons = {};
                const exitReasons = {};
                const mistakeStats = {};

                trades.forEach(trade => {
                    if (typeStats[trade.type]) {
                        typeStats[trade.type].total++;
                        typeStats[trade.type].pnl += trade.pnl;
                        if (trade.pnl > 0) typeStats[trade.type].wins++;
                    }
                    if (trade.session && sessionStats[trade.session]) {
                        sessionStats[trade.session].total++;
                        sessionStats[trade.session].pnl += trade.pnl;
                        if (trade.pnl > 0) sessionStats[trade.session].wins++;
                    }
                    if(trade.entryReason) entryReasons[trade.entryReason] = (entryReasons[trade.entryReason] || 0) + 1;
                    if(trade.exitReason) exitReasons[trade.exitReason] = (exitReasons[trade.exitReason] || 0) + 1;
                    if(trade.mistakes) trade.mistakes.forEach(m => mistakeStats[m] = (mistakeStats[m] || 0) + 1);
                });

                for (const type in typeStats) {
                    typeStats[type].winRate = typeStats[type].total > 0 ? (typeStats[type].wins / typeStats[type].total) * 100 : 0;
                }
                for (const session in sessionStats) { 
                    sessionStats[session].winRate = sessionStats[session].total > 0 ? (sessionStats[session].wins / sessionStats[session].total) * 100 : 0; 
                }
                
                container.innerHTML = `
                    <h3 class="section-title">Performance & Discipline Analyzer</h3>
                    <div class="detail-grid" style="margin-top: 1.5rem; margin-bottom: 0;">
                        <div class="stat-card">
                            <h4 class="stat-card-title">Key Performance Metrics</h4>
                            <div class="metric-group"><div><div class="stat-card-value">${winRate.toFixed(1)}%</div><div class="metric-label">Win Rate (${winningTrades}/${totalTrades})</div></div></div>
                            <div class="metric-group"><div><div class="stat-card-value ${avgPnl >= 0 ? 'pnl-profit' : 'pnl-loss'}">${formatCurrency(avgPnl)}</div><div class="metric-label">Avg. P/L per Trade</div></div></div>
                            <div class="metric-group"><div><div class="stat-card-value pnl-profit">${formatCurrency(bestTrade)}</div><div class="metric-label">Best Trade</div></div></div>
                            <div class="metric-group"><div><div class="stat-card-value pnl-loss">${formatCurrency(worstTrade)}</div><div class="metric-label">Worst Trade</div></div></div>
                        </div>
                        <div class="stat-card"><h4 class="stat-card-title">Discipline Metrics</h4><div class="metric-group"><div><div class="stat-card-value">${slUsedPercent.toFixed(1)}%</div><div class="metric-label">Stop Loss Used (${slUsed}/${totalTrades})</div></div></div><div class="metric-group"><div><div class="stat-card-value">${rrPlanFollowedPercent.toFixed(1)}%</div><div class="metric-label">R:R Plan Followed (${rrPlanFollowed}/${applicableRRTrades.length})</div></div></div></div>
                        <div class="stat-card"><h4 class="stat-card-title">Risk/Reward Analysis</h4><div class="metric-group"><div><div class="stat-card-value">${avgPlannedRR.toFixed(2)}R</div><div class="metric-label">Avg. Planned R:R</div></div></div><div class="metric-group"><div><div class="stat-card-value">${avgActualRR.toFixed(2)}R</div><div class="metric-label">Avg. Actual R:R</div></div></div></div>
                        <div class="stat-card" id="mistake-analysis-card" style="display: flex; flex-direction: column;">
                            <h4 class="stat-card-title">Mistake Analysis</h4>
                            <div id="mistake-list-content" style="flex-grow: 1; display: flex; flex-direction: column;"></div>
                        </div>
                        <div class="stat-card" style="grid-column: 1 / -1;">
                             <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                                <div>
                                    <h4 class="stat-card-title">By Trade Type</h4>
                                    <table class="comparison-table" style="margin-top: 1rem; font-size: 0.875rem;">
                                        <thead><tr><th>Type</th><th>Trades</th><th>Win Rate</th><th>Net P/L</th></tr></thead>
                                        <tbody>
                                            ${Object.entries(typeStats).map(([type, stats]) => `
                                            <tr>
                                                <td>${type}</td>
                                                <td>${stats.total}</td>
                                                <td>${stats.winRate.toFixed(1)}%</td>
                                                <td class="${stats.pnl >= 0 ? 'pnl-profit' : 'pnl-loss'}">${formatCurrency(stats.pnl)}</td>
                                            </tr>`).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                <div>
                                    <h4 class="stat-card-title">By Session</h4>
                                    <table class="comparison-table" style="margin-top: 1rem; font-size: 0.875rem;">
                                        <thead><tr><th>Session</th><th>Trades</th><th>Win Rate</th><th>Net P/L</th></tr></thead>
                                        <tbody>
                                            ${Object.entries(sessionStats).filter(([, stats]) => stats.total > 0).sort((a, b) => b[1].pnl - a[1].pnl).map(([session, stats]) => `
                                            <tr>
                                                <td>${session}</td>
                                                <td>${stats.total}</td>
                                                <td>${stats.winRate.toFixed(1)}%</td>
                                                <td class="${stats.pnl >= 0 ? 'pnl-profit' : 'pnl-loss'}">${formatCurrency(stats.pnl)}</td>
                                            </tr>`).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card" style="grid-column: 1 / -1; padding: 2rem;">
                            <h4 class="stat-card-title" style="margin-bottom: 2rem; justify-content: center;">Entry & Exit Reason Distribution</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                                ${generateReasonPieChartSVG(entryReasons, "Entry Reasons")}
                                ${generateReasonPieChartSVG(exitReasons, "Exit Reasons")}
                            </div>
                        </div>
                    </div>`;

                renderMistakeAnalysisContent(mistakeStats);
            };

            const generateEquityChartSVG = (account) => {
                const values = [account.allocatedFunds, ...account.trades.map(t => t.pnl)].reduce((acc, pnl) => { acc.push(acc[acc.length - 1] + pnl); return acc; }, [account.allocatedFunds]).slice(1);
                if (values.length < 2) return `<div style="height:100px; display:flex; align-items:center; justify-content:center; color: var(--text-secondary);">Not enough data</div>`;
                const width = 260, height = 100, padding = 5;
                const min = Math.min(...values), max = Math.max(...values);
                const range = max - min === 0 ? 1 : max - min;
                const points = values.map((v, i) => `${(i/(values.length-1))*(width-padding*2)+padding},${height-(((v-min)/range)*(height-padding*2)+padding)}`).join(' ');
                const areaPoints = `${points.split(' ')[0]} ${points} ${points.split(' ').pop().split(',')[0]},${height-padding} ${points.split(' ')[0].split(',')[0]},${height-padding}`;
                return `<svg class="performance-chart-svg" viewBox="0 0 ${width} ${height}"><defs><linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent-cyan)" stop-opacity="0.8"/><stop offset="100%" stop-color="var(--accent-cyan)" stop-opacity="0"/></linearGradient></defs><polyline class="chart-area" points="${areaPoints}"></polyline><polyline class="chart-line" points="${points}"></polyline></svg>`;
            };

            const renderProfileView = () => {
                profileView.innerHTML = `
                    <button id="back-to-dashboard-profile" class="back-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to Dashboard</button>
                    <div class="card">
                        <h2 class="section-title">Your Profile</h2>
                        <div class="profile-grid">
                             <form id="profile-form">
                                <div class="form-group full-width"><label for="profileName">Full Name</label><input type="text" id="profileName" value="${currentUser.name}" required /></div>
                                <div class="form-group full-width"><label for="profileEmail">Email</label><input type="email" id="profileEmail" value="${currentUser.email}" required /></div>
                                <div class="form-group full-width"><label for="profilePassword">New Password (optional)</label><input type="password" id="profilePassword" placeholder="Leave blank to keep current password" /></div>
                                <button type="submit" class="modal-submit">Save Changes</button>
                            </form>
                            <div class="profile-pic-section">
                                 <img src="${currentUser.profilePic}" alt="Profile Picture" class="profile-pic-preview" id="profilePicPreview">
                                 <label for="profilePicInput" class="profile-pic-label">Upload New Picture</label>
                                 <input type="file" id="profilePicInput" accept="image/*">
                            </div>
                        </div>
                    </div>`;
                
                profileView.querySelector('#back-to-dashboard-profile').addEventListener('click', () => switchView(dashboardView));
                profileView.querySelector('#profile-form').addEventListener('submit', handleProfileUpdate);
                profileView.querySelector('#profilePicInput').addEventListener('change', handleProfilePicChange);
                switchView(profileView);
            };

            const renderGoalsView = () => {
                goalsView.innerHTML = `
                    <button id="back-to-dashboard-goals" class="back-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to Dashboard</button>
                    <div class="header" style="margin-bottom: 1.5rem;">
                        <h2 class="section-title" style="border:none; margin:0;">Your Goals</h2>
                        <button id="add-goal-btn" class="modal-submit" style="grid-column: auto; margin: 0; padding: 0.75rem 1.25rem;">Add New Goal</button>
                    </div>
                    <div id="goals-grid" class="dashboard-grid"></div>`;
                
                const goalsGrid = goalsView.querySelector('#goals-grid');

                currentUser.goals.forEach(goal => {
                    let tradesForGoal;
                    let linkedAccountName = 'All Accounts';

                    if (goal.accountId) {
                        const account = currentUser.accounts.find(acc => acc.id === goal.accountId);
                        if (account) {
                            tradesForGoal = account.trades.filter(t => new Date(t.date) >= new Date(goal.creationDate));
                            linkedAccountName = account.name;
                        } else {
                            tradesForGoal = []; // No trades if account is not active
                            const deletedAccount = (currentUser.deletedAccounts || []).find(acc => acc.id === goal.accountId);
                            if (deletedAccount) {
                                linkedAccountName = `${deletedAccount.name} (Deleted)`;
                            } else {
                                linkedAccountName = 'Unlinked Account';
                            }
                        }
                    } else {
                        const allTrades = currentUser.accounts.flatMap(acc => acc.trades);
                        tradesForGoal = allTrades.filter(t => new Date(t.date) >= new Date(goal.creationDate));
                    }
                    
                    let current = 0;
                    let progressText = '';
                    let targetText = '';

                    if (goal.type === 'profit') {
                        current = tradesForGoal.reduce((sum, trade) => sum + trade.pnl, 0);
                        progressText = `${formatCurrency(current)} / ${formatCurrency(goal.target)}`;
                        targetText = `Target: ${formatCurrency(goal.target)}`;
                    } else if (goal.type === 'win_rate') {
                        const winningTrades = tradesForGoal.filter(t => t.pnl > 0).length;
                        current = tradesForGoal.length > 0 ? (winningTrades / tradesForGoal.length) * 100 : 0;
                        progressText = `${current.toFixed(1)}% / ${goal.target}%`;
                        targetText = `Target: ${goal.target}%`;
                    } else if (goal.type === 'consistency') {
                        const tradeDays = new Set(tradesForGoal.map(t => t.date.split('T')[0]));
                        current = tradeDays.size;
                        progressText = `${current} / ${goal.target} days`;
                        targetText = `Target: ${goal.target} days`;
                    } else if (goal.type === 'avg_rr') {
                        const rrTrades = tradesForGoal.filter(t => typeof t.actualRR === 'number');
                        current = rrTrades.length > 0 ? rrTrades.reduce((sum, t) => sum + t.actualRR, 0) / rrTrades.length : 0;
                        progressText = `${current.toFixed(2)}R / ${goal.target}R`;
                        targetText = `Target: ${goal.target}R`;
                    } else if (goal.type === 'total_trades') {
                        current = tradesForGoal.length;
                        progressText = `${current} / ${goal.target} trades`;
                        targetText = `Target: ${goal.target} trades`;
                    }
                    
                    const progressPercent = Math.min((current / goal.target) * 100, 100);
                    const statusIcon = goal.status === 'completed' ? '' : goal.status === 'failed' ? '' : '';
                    
                    goalsGrid.innerHTML += `
                        <div class="card goal-card" data-id="${goal.id}">
                            <div class="account-card-actions">
                                <button class="action-btn edit-goal-btn" data-id="${goal.id}" title="Edit Goal">${icons.edit}</button>
                                <button class="action-btn delete-goal-btn" data-id="${goal.id}" title="Delete Goal">${icons.delete}</button>
                            </div>
                            <div class="goal-header"><h3>${goal.title}</h3></div>
                            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: -0.75rem; margin-bottom: 0.5rem;">Linked to: <strong>${linkedAccountName}</strong></p>
                            <p class="goal-target">${targetText}</p>
                            <p class="progress-text">${progressText}</p>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: ${progressPercent}%"></div></div>
                            <div class="goal-footer">
                                <span class="status-badge status-${goal.status}">${statusIcon} ${goal.status}</span>
                                ${goal.deadline ? `<span class="deadline">Due: ${new Date(goal.deadline).toLocaleDateString()}</span>` : '<span></span>'}
                            </div>
                            ${goal.status === 'ongoing' ? `
                            <div class="goal-status-actions">
                                <button class="status-action-btn complete" data-id="${goal.id}">Mark Completed</button>
                                <button class="status-action-btn fail" data-id="${goal.id}">Mark Failed</button>
                            </div>` : ''}
                        </div>`;
                });
                
                goalsGrid.innerHTML += `
                    <div class="card add-account-card" id="add-goal-card-btn">
                        <div class="add-icon">${icons.add}</div><h3 style="font-weight: 600;">Set a New Goal</h3>
                    </div>`;

                goalsView.querySelector('#back-to-dashboard-goals').addEventListener('click', () => switchView(dashboardView));
                goalsView.querySelector('#add-goal-btn').addEventListener('click', () => openGoalModal());
                goalsView.querySelector('#add-goal-card-btn').addEventListener('click', () => openGoalModal());
                goalsGrid.addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-goal-btn');
                    const deleteBtn = e.target.closest('.delete-goal-btn');
                    const completeBtn = e.target.closest('.status-action-btn.complete');
                    const failBtn = e.target.closest('.status-action-btn.fail');
                    if (editBtn) openGoalModal(parseInt(editBtn.dataset.id));
                    else if (deleteBtn) handleDeleteGoal(parseInt(deleteBtn.dataset.id));
                    else if (completeBtn) handleUpdateGoalStatus(parseInt(completeBtn.dataset.id), 'completed');
                    else if (failBtn) handleUpdateGoalStatus(parseInt(failBtn.dataset.id), 'failed');
                });

                switchView(goalsView);
            };

            const renderTrashView = () => {
                trashView.innerHTML = `
                    <button id="back-to-dashboard-trash" class="back-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to Dashboard</button>
                    <h2 class="section-title">Trash</h2>
                    <p class="metric-label" style="margin-bottom: 1.5rem;">Deleted accounts can be restored or permanently deleted.</p>
                    
                    <div class="card" style="margin-bottom: 2rem;">
                        <form id="trash-filters-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: flex-end;">
                            <h4 style="font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); grid-column: 1 / -1; margin-bottom: 0.5rem;">Filter Deleted Accounts</h4>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="filterTrashPhase">Phase</label>
                                <select id="filterTrashPhase">
                                    <option value="all">All Phases</option>
                                    <option value="1st">1st</option>
                                    <option value="2nd">2nd</option>
                                    <option value="Passed">Passed</option>
                                    <option value="Demo">Demo</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="filterTrashDays">Deleted Within</label>
                                <select id="filterTrashDays">
                                    <option value="all">Any time</option>
                                    <option value="7">Last 7 days</option>
                                    <option value="30">Last 30 days</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="filterTrashTrades">Number of Trades</label>
                                <select id="filterTrashTrades">
                                    <option value="all">Any</option>
                                    <option value="0-15">0 - 15</option>
                                    <option value="16-30">16 - 30</option>
                                    <option value="31+">31+</option>
                                </select>
                            </div>
                            <button type="button" id="clear-trash-filters-btn" class="back-button" style="margin: 0; padding: 0.75rem 1.25rem; height: fit-content;">Clear Filters</button>
                        </form>
                    </div>

                    <div id="trash-grid" class="dashboard-grid"></div>
                `;

                const trashGrid = trashView.querySelector('#trash-grid');
                const filtersForm = trashView.querySelector('#trash-filters-form');
                const clearFiltersBtn = trashView.querySelector('#clear-trash-filters-btn');

                const applyTrashFilters = () => {
                    const deletedAccounts = currentUser.deletedAccounts || [];
                    const phaseFilter = filtersForm.querySelector('#filterTrashPhase').value;
                    const daysFilter = filtersForm.querySelector('#filterTrashDays').value;
                    const tradesFilter = filtersForm.querySelector('#filterTrashTrades').value;

                    let filteredAccounts = deletedAccounts.filter(account => {
                        // Phase filter
                        if (phaseFilter !== 'all' && account.phase !== phaseFilter) {
                            return false;
                        }

                        // Days filter
                        if (daysFilter !== 'all') {
                            const days = parseInt(daysFilter, 10);
                            const deletedDate = new Date(account.deletedDate);
                            const diffTime = Math.abs(new Date() - deletedDate);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            if (diffDays > days) {
                                return false;
                            }
                        }

                        // Trades filter
                        if (tradesFilter !== 'all') {
                            const numTrades = account.trades.length;
                            if (tradesFilter === '0-15' && (numTrades < 0 || numTrades > 15)) return false;
                            if (tradesFilter === '16-30' && (numTrades < 16 || numTrades > 30)) return false;
                            if (tradesFilter === '31+' && numTrades < 31) return false;
                        }

                        return true;
                    });
                    
                    renderFilteredTrashGrid(filteredAccounts);
                };
                
                const renderFilteredTrashGrid = (accountsToRender) => {
                    if (accountsToRender.length === 0) {
                        const allDeletedAccounts = currentUser.deletedAccounts || [];
                        const message = allDeletedAccounts.length > 0
                            ? 'No deleted accounts match the current filters.'
                            : 'The trash is empty.';
                        trashGrid.innerHTML = `<div class="card" style="grid-column: 1 / -1; text-align: center; padding: 3rem;"><p class="metric-label">${message}</p></div>`;
                    } else {
                        trashGrid.innerHTML = ''; // Clear previous content
                        accountsToRender.forEach(account => {
                            const deletedDate = new Date(account.deletedDate).toLocaleDateString();
                            trashGrid.innerHTML += `
                                <div class="card" data-id="${account.id}">
                                    <div class="account-card-header"><h3>${account.name}</h3><span class="phase-badge">${account.phase}</span></div>
                                    <div class="account-card-body" style="display:flex; justify-content: space-between; gap: 1rem; margin-top: 1.5rem;">
                                        <div class="metric"><div><p class="metric-value">${formatCurrency(account.equity)}</p><p class="metric-label">Final Equity</p></div></div>
                                        <div class="metric"><div><p class="metric-value">${account.trades.length}</p><p class="metric-label">Total Trades</p></div></div>
                                    </div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 1rem;">
                                        Deleted on: ${deletedDate}
                                    </div>
                                    <div class="trash-card-actions">
                                        <button class="trash-action-btn restore" data-id="${account.id}">Restore</button>
                                        <button class="trash-action-btn perm-delete" data-id="${account.id}">Delete Permanently</button>
                                    </div>
                                    <div style="text-align: center; margin-top: 1rem;">
                                        <a href="#" class="view-details-link" data-id="${account.id}" style="color: var(--accent-cyan); text-decoration: none; font-weight: 500; font-size: 0.9rem;">View Details</a>
                                    </div>
                                </div>
                            `;
                        });
                    }
                }
                
                // Initial render
                applyTrashFilters();
                
                // Add event listeners
                filtersForm.addEventListener('change', applyTrashFilters);
                clearFiltersBtn.addEventListener('click', () => {
                    filtersForm.reset();
                    applyTrashFilters();
                });

                trashView.querySelector('#back-to-dashboard-trash').addEventListener('click', () => switchView(dashboardView));
                
                trashGrid.addEventListener('click', (e) => {
                    const restoreBtn = e.target.closest('.restore');
                    const permDeleteBtn = e.target.closest('.perm-delete');
                    const viewDetailsLink = e.target.closest('.view-details-link');
                    
                    if (restoreBtn) {
                        handleRestoreAccount(parseInt(restoreBtn.dataset.id));
                    } else if (permDeleteBtn) {
                        handlePermanentDeleteAccount(parseInt(permDeleteBtn.dataset.id));
                    } else if (viewDetailsLink) {
                        e.preventDefault();
                        renderAccountDetail(parseInt(viewDetailsLink.dataset.id));
                    }
                });

                switchView(trashView);
            };

            const renderWithdrawalHistoryView = () => {
                let currentPage = 1;
                const itemsPerPage = 15;

                withdrawalHistoryView.innerHTML = `
                    <button id="back-to-dashboard-withdrawals" class="back-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to Dashboard</button>
                    <h2 class="section-title">Withdrawal History</h2>
                    
                    <div class="card" style="margin-bottom: 2rem;">
                        <form id="withdrawal-filters-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: flex-end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="filterWdAccount">Account</label>
                                <select id="filterWdAccount"></select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="filterWdFromDate">From Date</label>
                                <input type="date" id="filterWdFromDate">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="filterWdToDate">To Date</label>
                                <input type="date" id="filterWdToDate">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="filterWdMinAmount">Min Amount</label>
                                <input type="number" id="filterWdMinAmount" placeholder="$">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="filterWdMaxAmount">Max Amount</label>
                                <input type="number" id="filterWdMaxAmount" placeholder="$">
                            </div>
                            <button type="button" id="clear-wd-filters-btn" class="back-button" style="margin: 0; padding: 0.75rem 1.25rem; height: fit-content;">Clear Filters</button>
                        </form>
                    </div>

                    <div class="card">
                        <div id="withdrawal-log-container" class="trade-log-container"></div>
                        <div id="withdrawal-log-pagination-controls" style="padding-top: 1.5rem; border-top: 1px solid var(--border-color); margin-top: 1.5rem; min-height: 38px;"></div>
                    </div>
                `;

                const filterAccountSelect = withdrawalHistoryView.querySelector('#filterWdAccount');
                filterAccountSelect.innerHTML = `<option value="all">All Accounts</option>` + currentUser.accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');

                const renderTable = () => {
                    // 1. Gather all data
                    let allWithdrawals = [];
                    currentUser.accounts.forEach(acc => {
                        (acc.withdrawals || []).forEach(w => {
                            allWithdrawals.push({ ...w, accountName: acc.name, accountId: parseInt(acc.id) });
                        });
                    });
                    allWithdrawals.sort((a, b) => new Date(b.date) - new Date(a.date));

                    // 2. Apply filters
                    const accountFilter = withdrawalHistoryView.querySelector('#filterWdAccount').value;
                    const fromDate = withdrawalHistoryView.querySelector('#filterWdFromDate').value;
                    const toDate = withdrawalHistoryView.querySelector('#filterWdToDate').value;
                    const minAmount = parseFloat(withdrawalHistoryView.querySelector('#filterWdMinAmount').value);
                    const maxAmount = parseFloat(withdrawalHistoryView.querySelector('#filterWdMaxAmount').value);

                    let filteredData = allWithdrawals.filter(w => {
                        if (accountFilter !== 'all' && w.accountId != accountFilter) return false;
                        if (fromDate && w.date < fromDate) return false;
                        if (toDate && w.date > toDate) return false;
                        if (!isNaN(minAmount) && w.amount < minAmount) return false;
                        if (!isNaN(maxAmount) && w.amount > maxAmount) return false;
                        return true;
                    });
                    
                    // 3. Paginate
                    const container = withdrawalHistoryView.querySelector('#withdrawal-log-container');
                    const paginationContainer = withdrawalHistoryView.querySelector('#withdrawal-log-pagination-controls');
                    const totalItems = filteredData.length;
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    const startIndex = (currentPage - 1) * itemsPerPage;
                    const paginatedData = filteredData.slice(startIndex, startIndex + itemsPerPage);

                    if (paginatedData.length === 0) {
                        container.innerHTML = `<p style="text-align:center; color: var(--text-secondary); margin: 2rem 0;">No withdrawals found.</p>`;
                        paginationContainer.innerHTML = '';
                        return;
                    }

                    // 4. Render table
                    const tableRows = paginatedData.map(w => `
                        <tr>
                            <td>${new Date(w.date).toLocaleDateString()}</td>
                            <td>${w.accountName}</td>
                            <td class="pnl-loss">${formatCurrency(w.amount)}</td>
                            <td>${w.notes || ''}</td>
                        </tr>`).join('');

                    container.innerHTML = `
                        <table class="trade-log-table" style="margin-top:0;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Account</th>
                                    <th>Amount</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    `;

                    // 5. Render pagination controls
                    let paginationHTML = '';
                    if (totalPages > 1) {
                        paginationHTML = `<div style="display: flex; justify-content: space-between; align-items: center; max-width: 300px; margin: 0 auto;">`;
                        paginationHTML += `<button id="prev-wd-page-btn" class="back-button" style="margin: 0;" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
                        paginationHTML += `<span style="color: var(--text-secondary); font-size: 0.9rem;">Page ${currentPage} of ${totalPages}</span>`;
                        paginationHTML += `<button id="next-wd-page-btn" class="back-button" style="margin: 0;" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
                        paginationHTML += `</div>`;
                    }
                    paginationContainer.innerHTML = paginationHTML;

                    paginationContainer.querySelector('#prev-wd-page-btn')?.addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            renderTable();
                        }
                    });
                    paginationContainer.querySelector('#next-wd-page-btn')?.addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            renderTable();
                        }
                    });
                };
                
                const resetAndRender = () => {
                    currentPage = 1;
                    renderTable();
                }

                withdrawalHistoryView.querySelector('#back-to-dashboard-withdrawals').addEventListener('click', () => switchView(dashboardView));
                withdrawalHistoryView.querySelector('#withdrawal-filters-form').addEventListener('input', resetAndRender);
                withdrawalHistoryView.querySelector('#clear-wd-filters-btn').addEventListener('click', () => {
                    withdrawalHistoryView.querySelector('#withdrawal-filters-form').reset();
                    resetAndRender();
                });
                
                renderTable(); // Initial render
                switchView(withdrawalHistoryView);
            };

            // --- SMART INSIGHTS ---
            const generateAndRenderSmartInsights = async () => {
                const container = document.getElementById('smart-insights-container');
                if (!container) return;

                const allTrades = currentUser.accounts.flatMap(acc => acc.trades);
                if (allTrades.length < 5) {
                    container.innerHTML = `<h3 class="section-title" style="border:none; margin-bottom:0.5rem;">Smart Insights</h3><p style="text-align:center; color: var(--text-secondary); padding: 1rem 0;">Log more trades to generate automated insights.</p>`;
                    return;
                }
                
                container.innerHTML = `<h3 class="section-title" style="border:none; margin-bottom:0.5rem;">Smart Insights</h3><p style="text-align:center; color: var(--text-secondary); padding: 1rem 0;">Analyzing your trades...</p>`;

                let insights = [];

                // Insight 1: Over-risking
                const overRiskedTrades = allTrades.filter(t => t.riskPercent && t.riskPercent > 3);
                if (overRiskedTrades.length > 2) {
                    insights.push({ text: `You've made ${overRiskedTrades.length} trades risking over 3%, increasing portfolio volatility.`, severity: 'red', priority: 1 });
                }

                // Insight 2: Ignoring Stop Loss
                const noSlTrades = allTrades.filter(t => t.stopLossUsed === 'No');
                if (noSlTrades.length > 2) {
                    insights.push({ text: `You have ${noSlTrades.length} trades logged without a stop loss. Consider using one for every trade.`, severity: 'red', priority: 2 });
                }
                
                // Insight 3: Poor R:R Discipline
                const poorRrTrades = allTrades.filter(t => typeof t.plannedRR === 'number' && typeof t.actualRR === 'number' && t.actualRR < t.plannedRR);
                const poorRrPercentage = (poorRrTrades.length / allTrades.length) * 100;
                if (poorRrPercentage > 40) {
                    insights.push({ text: `On ${poorRrPercentage.toFixed(0)}% of trades, you're exiting before reaching the planned R:R.`, severity: 'yellow', priority: 3 });
                }

                // Insight 4: Session Performance
                const sessionPnl = allTrades.reduce((acc, trade) => {
                    if (trade.session) {
                        acc[trade.session] = (acc[trade.session] || 0) + trade.pnl;
                    }
                    return acc;
                }, {});
                const sortedSessions = Object.entries(sessionPnl).sort(([, a], [, b]) => a - b);
                if (sortedSessions.length > 0 && sortedSessions[0][1] < 0) {
                    const worstSession = sortedSessions[0][0];
                    insights.push({ text: `Your biggest losses are coming from the ${worstSession} session.`, severity: 'yellow', priority: 4 });
                }
                 if (sortedSessions.length > 0 && sortedSessions[sortedSessions.length - 1][1] > 0) {
                    const bestSession = sortedSessions[sortedSessions.length - 1][0];
                    insights.push({ text: `You are most profitable during the ${bestSession} session. Keep capitalizing on it.`, severity: 'green', priority: 7 });
                }

                // Insight 5: FOMO Entries
                const fomoTrades = allTrades.filter(t => t.entryReason === 'FOMO');
                if (fomoTrades.length > 2) {
                    insights.push({ text: `${fomoTrades.length} trades were driven by FOMO. Sticking to the plan could improve results.`, severity: 'yellow', priority: 5 });
                }

                // Insight 6: Good Discipline (Positive)
                const followedPlanTrades = allTrades.filter(t => t.entryReason === 'Following Plan');
                const followedPlanPercentage = (followedPlanTrades.length / allTrades.length) * 100;
                if (followedPlanPercentage > 70) {
                    insights.push({ text: `Great discipline! ${followedPlanPercentage.toFixed(0)}% of your trades are based on your plan.`, severity: 'green', priority: 6 });
                }

                // AI Insight from Notes
                const allNotes = allTrades.map(t => t.notes).filter(Boolean).join('\n---\n');
                if (allNotes.trim().length > 50) {
                    try {
                        const { GoogleGenAI } = window.ai;
                        const ai = new GoogleGenAI({apiKey: process.env.API_KEY});
                        const prompt = `Analyze the following trading journal notes. Identify the single most important recurring psychological pattern or mistake (like FOMO, revenge trading, fear, greed, poor discipline). Provide one concise, actionable insight based on this theme. The notes can be in English or Hindi. Respond with only the insight. Notes:\n\n"${allNotes}"`;
                        
                        const response = await ai.models.generateContent({
                            model: 'gemini-2.5-flash',
                            contents: prompt,
                        });

                        const insightText = response.text;

                        if (insightText) {
                            insights.push({
                                text: `Insight from your notes: ${insightText.trim()}`,
                                severity: 'yellow',
                                priority: 2.5
                            });
                        }
                    } catch (error) {
                        console.error("Error fetching insight from AI:", error);
                    }
                }
                
                const sortedInsights = insights.sort((a, b) => a.priority - b.priority).slice(0, 4);

                let insightsHTML = `<h3 class="section-title" style="border:none; margin-bottom:0.5rem;">Smart Insights</h3><ul class="insights-list">`;
                if (sortedInsights.length > 0) {
                    sortedInsights.forEach(insight => {
                        insightsHTML += `<li class="insight-item">
                            <span class="insight-dot ${insight.severity}"></span>
                            <p>${insight.text}</p>
                        </li>`;
                    });
                } else {
                    insightsHTML += `<li class="insight-item">
                        <span class="insight-dot green"></span>
                        <p>No significant negative patterns detected. Keep up the good work!</p>
                    </li>`;
                }
                insightsHTML += `</ul>`;

                container.innerHTML = insightsHTML;
            };

            // --- EXIT ANALYSIS ---
            const getExitAnalysisData = () => {
                const allTrades = currentUser.accounts.flatMap(acc => acc.trades);
                const tradesWithExitData = allTrades.filter(t => t.afterExitMove);
                if (tradesWithExitData.length === 0) return null;

                const outcomes = {
                    'Continued in Same Direction': 0,
                    'Reversed Immediately': 0,
                    'Went Slightly in Same Direction then Reversed': 0,
                    'Consolidated (No Major Move)': 0
                };

                tradesWithExitData.forEach(trade => {
                    if (outcomes.hasOwnProperty(trade.afterExitMove)) {
                        outcomes[trade.afterExitMove]++;
                    }
                });

                const percentages = {};
                for (const key in outcomes) {
                    percentages[key] = (outcomes[key] / tradesWithExitData.length) * 100;
                }

                return { counts: outcomes, percentages, trades: tradesWithExitData, total: tradesWithExitData.length };
            };

            const generateExitAnalysisInsights = (data) => {
                let insights = [];
                if (!data) return insights;

                if (data.percentages['Reversed Immediately'] >= 40) {
                    insights.push({ text: "A high number of trades reverse immediately after exit. You might be closing profitable trades too early.", severity: 'red' });
                }
                if (data.percentages['Continued in Same Direction'] >= 40) {
                    insights.push({ text: "You may be leaving money on the table. Consider trailing stops or multiple take-profit levels.", severity: 'yellow' });
                }
                if (data.percentages['Went Slightly in Same Direction then Reversed'] >= 30) {
                    insights.push({ text: "Your exits often precede reversals. A partial take-profit strategy could capture the initial move while reducing risk.", severity: 'yellow' });
                }
                 if (insights.length === 0) {
                    insights.push({text: "Your post-exit outcomes show a balanced distribution. No strong negative patterns detected.", severity: 'green'});
                }
                return insights;
            };

            const renderDashboardExitAnalysisWidgets = () => {
                const container = document.getElementById('exit-analysis-widgets-container');
                if (!container) return;

                const data = getExitAnalysisData();
                if (!data) {
                    container.innerHTML = '';
                    return;
                }

                const summaryHTML = `
                    <div class="card">
                        <h4 class="stat-card-title" style="margin-bottom: 1rem;">Post-Exit Market Behavior</h4>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); display: flex; flex-wrap: wrap; gap: 0.5rem 1rem;">
                            <span title="Continued in Same Direction"><strong style="color:var(--status-good);">${data.percentages['Continued in Same Direction'].toFixed(0)}%</strong> Continued</span>
                            <span title="Reversed Immediately"><strong style="color:var(--status-bad);">${data.percentages['Reversed Immediately'].toFixed(0)}%</strong> Reversed</span>
                            <span title="Went Slightly in Same Direction then Reversed"><strong style="color:var(--status-avg);">${data.percentages['Went Slightly in Same Direction then Reversed'].toFixed(0)}%</strong> Slight/Reverse</span>
                            <span title="Consolidated (No Major Move)"><strong style="color:var(--text-secondary);">${data.percentages['Consolidated (No Major Move)'].toFixed(0)}%</strong> Consolidated</span>
                        </div>
                    </div>`;

                const insights = generateExitAnalysisInsights(data);
                let insightHighlightHTML = '';
                if (insights.length > 0) {
                    insightHighlightHTML = `
                    <div class="card" id="ai-insight-highlight-widget" style="cursor: pointer;">
                        <h4 class="stat-card-title" style="margin-bottom: 1rem;">AI Insight Highlight</h4>
                        <div class="insight-item" style="gap: 0.75rem;">
                            <span class="insight-dot ${insights[0].severity}"></span>
                            <p style="font-size: 0.9rem;">${insights[0].text}</p>
                        </div>
                    </div>`;
                }

                container.innerHTML = summaryHTML + insightHighlightHTML;

                const highlightWidget = document.getElementById('ai-insight-highlight-widget');
                if (highlightWidget) {
                    highlightWidget.addEventListener('click', () => {
                        renderExitAnalysisView();
                    });
                }
            };
            
            const renderExitAnalysisView = () => {
                 exitAnalysisView.innerHTML = `
                    <button id="back-to-dashboard-exit" class="back-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>Back to Dashboard</button>
                    <h2 class="section-title">Exit Analysis</h2>
                    <div id="exit-analysis-content" class="dashboard-grid" style="grid-template-columns: 1fr; gap: 2rem;"></div>
                `;
                exitAnalysisView.querySelector('#back-to-dashboard-exit').addEventListener('click', () => switchView(dashboardView));

                const container = exitAnalysisView.querySelector('#exit-analysis-content');
                const data = getExitAnalysisData();

                if (!data) {
                    container.innerHTML = `<div class="card" style="text-align:center; padding: 3rem;"><p class="metric-label">No post-exit data has been logged yet. Start adding the "After Exit Market Move" to your trades to see analysis here.</p></div>`;
                    switchView(exitAnalysisView);
                    return;
                }

                const outcomeColors = {
                    'Continued in Same Direction': 'var(--status-good)',
                    'Reversed Immediately': 'var(--status-bad)',
                    'Went Slightly in Same Direction then Reversed': 'var(--status-avg)',
                    'Consolidated (No Major Move)': 'var(--text-secondary)'
                };

                const distributionCard = `
                    <div class="card" style="grid-column: 1 / -1;">
                        <h3 class="section-title" style="border:none; margin-bottom: 1.5rem;">Outcome Distribution</h3>
                        ${generateReasonPieChartSVG(data.counts, "Post-Exit Outcomes", outcomeColors)}
                    </div>`;

                const timelineCard = `
                    <div class="card" style="grid-column: 1 / -1;">
                         <h3 class="section-title" style="border:none; margin-bottom: 1.5rem;">Outcome Timeline</h3>
                         <div id="exit-timeline-chart-container" style="width: 100%; height: 300px;"></div>
                    </div>`;
                
                const insights = generateExitAnalysisInsights(data);
                const insightsCard = `
                    <div class="card" style="grid-column: 1 / -1;">
                        <h3 class="section-title" style="border:none; margin-bottom: 1rem;">AI-Powered Insights</h3>
                        <ul class="insights-list">
                            ${insights.map(insight => `
                                <li class="insight-item">
                                    <span class="insight-dot ${insight.severity}"></span>
                                    <p>${insight.text}</p>
                                </li>`).join('')}
                        </ul>
                    </div>`;

                container.innerHTML = distributionCard + timelineCard + insightsCard;
                
                // Render timeline chart
                const timelineContainer = document.getElementById('exit-timeline-chart-container');
                timelineContainer.innerHTML = generateTimelineChartSVG(data.trades);
                
                switchView(exitAnalysisView);
            };

            const generateTimelineChartSVG = (trades) => {
                if (!trades || trades.length === 0) return `<div style="text-align:center; color: var(--text-secondary);">Not enough data for timeline.</div>`;

                const getWeekNumber = (d) => {
                    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                    var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                    var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
                    return `${d.getUTCFullYear()}-W${weekNo}`;
                }
                
                const outcomeKeys = ['Continued in Same Direction', 'Reversed Immediately', 'Went Slightly in Same Direction then Reversed', 'Consolidated (No Major Move)'];
                const outcomeColors = {
                    'Continued in Same Direction': 'var(--status-good)',
                    'Reversed Immediately': 'var(--status-bad)',
                    'Went Slightly in Same Direction then Reversed': 'var(--status-avg)',
                    'Consolidated (No Major Move)': 'var(--text-secondary)'
                };

                const dataByWeek = trades.reduce((acc, trade) => {
                    const week = getWeekNumber(new Date(trade.date));
                    if (!acc[week]) {
                        acc[week] = { 'Continued in Same Direction': 0, 'Reversed Immediately': 0, 'Went Slightly in Same Direction then Reversed': 0, 'Consolidated (No Major Move)': 0 };
                    }
                    if(trade.afterExitMove) acc[week][trade.afterExitMove]++;
                    return acc;
                }, {});

                const sortedWeeks = Object.keys(dataByWeek).sort();
                const chartData = sortedWeeks.map(week => ({ week, ...dataByWeek[week] }));

                const margin = {top: 20, right: 20, bottom: 40, left: 40};
                const width = 1100 - margin.left - margin.right;
                const height = 300 - margin.top - margin.bottom;

                let svg = `<svg viewBox="0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}" style="font-size: 12px; color: var(--text-secondary);">`;
                svg += `<g transform="translate(${margin.left},${margin.top})">`;

                const maxCount = Math.max(...chartData.map(d => outcomeKeys.reduce((sum, key) => sum + d[key], 0)));
                const barWidth = width / (chartData.length * 1.5);

                // Y-axis
                const numYTicks = 5;
                for (let i = 0; i <= numYTicks; i++) {
                    const val = (maxCount / numYTicks) * i;
                    const y = height - (val / maxCount) * height;
                    svg += `<line x1="0" y1="${y}" x2="${width}" y2="${y}" stroke="var(--border-color)" stroke-dasharray="2,2" />`;
                    svg += `<text x="-10" y="${y}" dy="0.32em" text-anchor="end" fill="currentColor">${Math.round(val)}</text>`;
                }

                // X-axis and bars
                chartData.forEach((d, i) => {
                    const x = (width / chartData.length) * (i + 0.5) - barWidth / 2;
                    let currentY = height;

                    outcomeKeys.forEach(key => {
                        const count = d[key];
                        if(count > 0) {
                            const barHeight = (count / maxCount) * height;
                            svg += `<rect x="${x}" y="${currentY - barHeight}" width="${barWidth}" height="${barHeight}" fill="${outcomeColors[key]}" />`;
                            currentY -= barHeight;
                        }
                    });

                    svg += `<text x="${x + barWidth / 2}" y="${height + 15}" text-anchor="middle" fill="currentColor">${d.week.replace('-W', ' W')}</text>`;
                });
                
                svg += `</g></svg>`;

                // Legend
                const legend = `<div style="display: flex; justify-content: center; gap: 1.5rem; margin-top: 1rem; font-size: 0.8rem;">
                    ${outcomeKeys.map(key => `
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background-color: ${outcomeColors[key]}; border-radius: 3px;"></div>
                            <span>${key.replace(' in Same Direction', '').replace(' Immediately', '').replace('Went Slightly in Same Direction then Reversed', 'Slight/Reverse').replace('(No Major Move)','')}</span>
                        </div>
                    `).join('')}
                </div>`;

                return svg + legend;
            };

            // --- EVENT HANDLERS & LOGIC ---
            const handleProfileUpdate = (e) => {
                e.preventDefault();
                const newName = document.getElementById('profileName').value;
                const newEmail = document.getElementById('profileEmail').value;
                const newPassword = document.getElementById('profilePassword').value;

                if (users.some(u => u.email === newEmail && u.email !== currentUser.email)) {
                    alert('This email is already taken.'); return;
                }
                
                currentUser.name = newName;
                currentUser.email = newEmail;
                if (newPassword) currentUser.password = newPassword; 
                saveUsers();
                localStorage.setItem('edgeplus_currentUser', newEmail);
                updateUIForCurrentUser();
                alert('Profile updated successfully!');
            };

            const handleProfilePicChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const dataUrl = await readFileAsDataURL(file);
                currentUser.profilePic = dataUrl;
                saveUsers();
                updateUIForCurrentUser();
            };
            
            const openModal = (accountId = null) => {
                accountForm.reset();
                const modalTitle = document.getElementById('modal-title');
                const netProfitInput = document.getElementById('netProfit');

                if (accountId) {
                    const account = currentUser.accounts.find(acc => acc.id === accountId);
                    modalTitle.textContent = 'Edit Account';
                    accountForm.accountId.value = account.id;
                    accountForm.accountName.value = account.name;
                    accountForm.allocatedFunds.value = account.allocatedFunds;
                    netProfitInput.value = account.initialNetProfit || 0;
                    accountForm.lossLimit.value = account.lossLimit || '';
                    accountForm.accountPhase.value = account.phase || 'Demo';
                } else {
                    modalTitle.textContent = 'Add New Account';
                    accountForm.accountId.value = '';
                    netProfitInput.value = '0';
                    accountForm.accountPhase.value = 'Demo';
                }
                modal.classList.add('visible');
            };

            const closeModal = () => modal.classList.remove('visible');
            
            const handleAccountFormSubmit = (e) => {
                e.preventDefault();
                const accountId = parseInt(accountForm.accountId.value);
                const accountData = {
                    name: accountForm.accountName.value,
                    allocatedFunds: parseFloat(document.getElementById('allocatedFunds').value),
                    initialNetProfit: parseFloat(document.getElementById('netProfit').value),
                    lossLimit: accountForm.lossLimit.value ? parseFloat(accountForm.lossLimit.value) : null,
                    phase: accountForm.accountPhase.value,
                };

                if (accountId) {
                    const index = currentUser.accounts.findIndex(acc => acc.id === accountId);
                    const account = currentUser.accounts[index];
                    const tradesPnl = account.trades.reduce((sum, trade) => sum + trade.pnl, 0);
                    const totalWithdrawals = (account.withdrawals || []).reduce((sum, w) => sum + w.amount, 0);

                    account.name = accountData.name;
                    account.allocatedFunds = accountData.allocatedFunds;
                    account.initialNetProfit = accountData.initialNetProfit;
                    account.lossLimit = accountData.lossLimit;
                    account.phase = accountData.phase;
                    account.equity = account.allocatedFunds + account.initialNetProfit + tradesPnl - totalWithdrawals;
                } else {
                    const allAccountIds = [...currentUser.accounts, ...(currentUser.deletedAccounts || [])].map(a => a.id);
                    const newId = allAccountIds.length > 0 ? Math.max(...allAccountIds) + 1 : 1;
                    currentUser.accounts.push({ 
                        id: newId, 
                        ...accountData, 
                        equity: accountData.allocatedFunds + accountData.initialNetProfit,
                        trades: [],
                        withdrawals: [],
                        creationDate: new Date().toISOString() 
                    });
                }
                
                saveUsers();
                renderDashboard();
                closeModal();
            };

            const handleAddTrade = async (e, accountId) => {
                e.preventDefault();
                const account = currentUser.accounts.find(acc => acc.id === accountId);
                if (!account) return;
                const form = e.target;
                const attachmentInput = form.querySelector('#tradeAttachment');
                let attachmentData = null;
                let attachmentName = null;
                let attachmentType = null;
                if (attachmentInput.files.length > 0) {
                    const file = attachmentInput.files[0];
                    attachmentData = await readFileAsDataURL(file);
                    attachmentName = file.name;
                    attachmentType = file.type;
                }
                
                const selectedMistakes = Array.from(form.querySelectorAll('input[name="mistake"]:checked')).map(cb => cb.value);

                let entryReason = form.tradeEntryReasonSelect.value;
                const mistakeEntryReasons = ["FOMO Entry", "Revenge Entry", "Overconfidence"];
                if (mistakeEntryReasons.includes(entryReason)) {
                    selectedMistakes.push(entryReason);
                }

                if (entryReason === 'ICT Setup') {
                    entryReason = `ICT: ${form.tradeIctSetupSelect.value}`;
                } else if (entryReason === 'Custom Setup') {
                    const customReasonInput = form.tradeEntryReasonOther.value.trim();
                    if (customReasonInput) {
                        entryReason = customReasonInput;
                        const customReasons = currentUser.customEntryReasons || [];
                        if (!customReasons.includes(entryReason)) {
                            customReasons.push(entryReason);
                            currentUser.customEntryReasons = customReasons;
                        }
                    } else {
                        entryReason = 'Custom Setup'; 
                    }
                }
                
                let exitReason = form.tradeExitReasonSelect.value;
                const mistakeExitReasons = ["Fear Exit", "Greed Exit"];
                if (mistakeExitReasons.includes(exitReason)) {
                    selectedMistakes.push(exitReason);
                }
                if(exitReason === 'Other') exitReason = form.tradeExitReasonOther.value.trim() || 'Other';
                
                const newTrade = {
                    id: account.trades.length > 0 ? Math.max(...account.trades.map(t => t.id)) + 1 : 1,
                    date: new Date().toISOString(),
                    pair: form.tradePair.value, type: form.tradeType.value,
                    lot: parseFloat(form.tradeLot.value), entry: parseFloat(form.tradeEntry.value),
                    exit: parseFloat(form.tradeExit.value), pnl: parseFloat(form.tradePnl.value),
                    plannedRR: form.tradePlannedRR.value ? parseFloat(form.tradePlannedRR.value) : null,
                    actualRR: form.tradeActualRR.value ? parseFloat(form.tradeActualRR.value) : null,
                    riskPercent: form.tradeRiskPercent.value ? parseFloat(form.tradeRiskPercent.value) : null,
                    stopLossUsed: form.tradeStopLossUsed.value,
                    session: form.tradeSession.value,
                    timeFrame: form.tradeTimeFrame.value,
                    mood: form.tradeMood.value,
                    entryReason: entryReason,
                    exitReason: exitReason,
                    afterExitMove: form.tradeAfterExitMove.value,
                    notes: form.tradeNotes.value, 
                    attachment: attachmentData,
                    attachmentName: attachmentName,
                    attachmentType: attachmentType,
                    mistakes: selectedMistakes
                };
                
                if (newTrade.actualRR !== null && newTrade.plannedRR !== null && newTrade.actualRR < newTrade.plannedRR) {
                    newTrade.mistakes.push('Poor R:R Discipline');
                }
                if (newTrade.riskPercent !== null && newTrade.riskPercent > 3) {
                    newTrade.mistakes.push('Over-risked');
                }
                newTrade.mistakes = [...new Set(newTrade.mistakes)];

                account.trades.push(newTrade);
                account.equity += newTrade.pnl;
                saveUsers();
                renderDashboard();
                renderAccountDetail(accountId);
            };

            const updateUIForCurrentUser = () => {
                if (!currentUser) return;
                document.getElementById('header-avatar').src = currentUser.profilePic;
                document.getElementById('drawer-avatar').src = currentUser.profilePic;
                document.getElementById('drawer-username').textContent = currentUser.name;
                if(document.getElementById('profilePicPreview')) {
                    document.getElementById('profilePicPreview').src = currentUser.profilePic;
                }
            };
            
            const openGoalModal = (goalId = null) => {
                goalForm.reset();
                const modalTitle = document.getElementById('goal-modal-title');
                
                const goalAccountSelect = document.getElementById('goalAccount');
                goalAccountSelect.innerHTML = `<option value="all">All Accounts</option>`;
                currentUser.accounts.forEach(acc => {
                    goalAccountSelect.innerHTML += `<option value="${acc.id}">${acc.name}</option>`;
                });
                
                if (goalId) {
                    const goal = currentUser.goals.find(g => g.id === goalId);
                    modalTitle.textContent = 'Edit Goal';
                    goalForm.goalId.value = goal.id;
                    goalForm.goalTitle.value = goal.title;
                    goalForm.goalType.value = goal.type;
                    goalForm.goalTarget.value = goal.target;
                    goalForm.goalDeadline.value = goal.deadline;
                    goalForm.goalAccount.value = goal.accountId || 'all';
                } else {
                    modalTitle.textContent = 'Set New Goal';
                    goalForm.goalId.value = '';
                }
                goalModal.classList.add('visible');
            };

            const closeGoalModal = () => goalModal.classList.remove('visible');

            const handleGoalFormSubmit = (e) => {
                e.preventDefault();
                const goalId = parseInt(goalForm.goalId.value);
                const accountIdValue = goalForm.goalAccount.value;
                const goalData = {
                    title: goalForm.goalTitle.value,
                    type: goalForm.goalType.value,
                    target: parseFloat(goalForm.goalTarget.value),
                    deadline: goalForm.goalDeadline.value || null,
                    accountId: accountIdValue === 'all' ? null : parseInt(accountIdValue)
                };
                if(goalId) {
                    const index = currentUser.goals.findIndex(g => g.id === goalId);
                    currentUser.goals[index] = { ...currentUser.goals[index], ...goalData };
                } else {
                    const newId = currentUser.goals.length > 0 ? Math.max(...currentUser.goals.map(g => g.id)) + 1 : 1;
                    currentUser.goals.push({ id: newId, ...goalData, status: 'ongoing', creationDate: new Date().toISOString() });
                }
                saveUsers();
                renderGoalsView();
                closeGoalModal();
            };
            
            const handleDeleteGoal = (goalId) => {
                if (confirm('Are you sure you want to delete this goal?')) {
                    currentUser.goals = currentUser.goals.filter(g => g.id !== goalId);
                    saveUsers();
                    renderGoalsView();
                }
            };
            
            const handleUpdateGoalStatus = (goalId, newStatus) => {
                 const goal = currentUser.goals.find(g => g.id === goalId);
                 if (goal) {
                    goal.status = newStatus;
                    saveUsers();
                    renderGoalsView();
                 }
            };

            const openWithdrawalModal = (accountId) => {
                withdrawalForm.reset();
                document.getElementById('withdrawalAccountId').value = accountId;
                document.getElementById('withdrawalDate').valueAsDate = new Date();
                withdrawalModal.classList.add('visible');
            };

            const closeWithdrawalModal = () => withdrawalModal.classList.remove('visible');

            const handleWithdrawalFormSubmit = (e) => {
                e.preventDefault();
                const accountId = parseInt(document.getElementById('withdrawalAccountId').value);
                const account = currentUser.accounts.find(acc => acc.id === accountId);
                if (!account) return;

                const amount = parseFloat(document.getElementById('withdrawalAmount').value);
                if (isNaN(amount) || amount <= 0) {
                    alert("Please enter a valid, positive withdrawal amount.");
                    return;
                }

                const newWithdrawal = {
                    id: (account.withdrawals && account.withdrawals.length > 0 ? Math.max(...account.withdrawals.map(w => w.id)) : 0) + 1,
                    amount: amount,
                    date: document.getElementById('withdrawalDate').value,
                    notes: document.getElementById('withdrawalNotes').value,
                };

                account.withdrawals = account.withdrawals || [];
                account.withdrawals.push(newWithdrawal);
                account.equity -= amount;

                saveUsers();
                closeWithdrawalModal();
                renderAccountDetail(accountId);
                renderDashboard();
            };
            
            const handleSoftDeleteAccount = (accountId) => {
                const accountIndex = currentUser.accounts.findIndex(acc => acc.id === accountId);
                if (accountIndex > -1) {
                    const [deletedAccount] = currentUser.accounts.splice(accountIndex, 1);
                    deletedAccount.deletedDate = new Date().toISOString();
                    currentUser.deletedAccounts = currentUser.deletedAccounts || [];
                    currentUser.deletedAccounts.push(deletedAccount);
                    saveUsers();
                    renderDashboard();
                    return true;
                }
                return false;
            };

            const handleRestoreAccount = (accountId) => {
                const accountIndex = currentUser.deletedAccounts.findIndex(acc => acc.id === accountId);
                if (accountIndex > -1) {
                    const [restoredAccount] = currentUser.deletedAccounts.splice(accountIndex, 1);
                    delete restoredAccount.deletedDate; // Remove the deleted date
                    currentUser.accounts.push(restoredAccount);
                    // Sort accounts by ID for consistent order
                    currentUser.accounts.sort((a, b) => a.id - b.id);
                    saveUsers();
                    renderTrashView(); // Re-render the trash view
                }
            };

            const handlePermanentDeleteAccount = (accountId) => {
                if (confirm('Are you sure you want to permanently delete this account? This action cannot be undone.')) {
                    currentUser.deletedAccounts = currentUser.deletedAccounts.filter(acc => acc.id !== accountId);
                    // Also remove any goals associated with the permanently deleted account for data integrity.
                    currentUser.goals = currentUser.goals.filter(goal => goal.accountId !== accountId);
                    saveUsers();
                    renderTrashView(); // Re-render the trash view
                }
            };

            // --- COMPARISON SECTION ---
            let comparisonState = {
                timeframe: '30D',
                mode: 'normalized',
                sortBy: 'pnlPercent',
                sortOrder: 'desc',
                visibleAccounts: new Set()
            };

            const saveComparisonState = () => {
                if (!currentUser) return;
                const stateToSave = {
                    ...comparisonState,
                    visibleAccounts: Array.from(comparisonState.visibleAccounts)
                };
                localStorage.setItem(`edgeplus_comparison_state_${currentUser.email}`, JSON.stringify(stateToSave));
            };

            const renderComparisonSection = () => {
                const container = document.getElementById('comparison-section-container');
                if (!container) return;

                if (currentUser.accounts.length < 1) {
                    container.innerHTML = '';
                    return;
                }
                
                container.innerHTML = `
                    <div class="card comparison-card" id="overall-comparison-section">
                        <div class="comparison-header">
                            <h3>Overall Comparison</h3>
                            <div class="comparison-controls">
                                <div class="toggle-group" id="comparison-mode-toggle">
                                    <button data-mode="normalized" class="${comparisonState.mode === 'normalized' ? 'active' : ''}">Normalized</button>
                                    <button data-mode="absolute" class="${comparisonState.mode === 'absolute' ? 'active' : ''}">Absolute</button>
                                </div>
                                <div class="toggle-group" id="comparison-timeframe-toggle">
                                    <button data-tf="7D" class="${comparisonState.timeframe === '7D' ? 'active' : ''}">7D</button>
                                    <button data-tf="30D" class="${comparisonState.timeframe === '30D' ? 'active' : ''}">30D</button>
                                    <button data-tf="90D" class="${comparisonState.timeframe === '90D' ? 'active' : ''}">90D</button>
                                    <button data-tf="All" class="${comparisonState.timeframe === 'All' ? 'active' : ''}">All</button>
                                </div>
                                <button id="export-csv-btn" class="action-btn" title="Export as CSV">${icons.export}</button>
                            </div>
                        </div>
                        <div class="comparison-body">
                            <div class="comparison-chart-pane">
                                <div id="comparison-chart-container"><div class="comparison-chart-tooltip"></div></div>
                                <div id="comparison-chart-legend"></div>
                            </div>
                            <div class="comparison-list-pane">
                                <div id="comparison-list-container"></div>
                            </div>
                        </div>
                    </div>`;

                updateComparisonView();

                // Add event listeners
                container.querySelector('#comparison-mode-toggle').addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        comparisonState.mode = e.target.dataset.mode;
                        saveComparisonState();
                        updateComparisonView();
                    }
                });
                container.querySelector('#comparison-timeframe-toggle').addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        comparisonState.timeframe = e.target.dataset.tf;
                        saveComparisonState();
                        updateComparisonView();
                    }
                });
                container.querySelector('#export-csv-btn').addEventListener('click', () => {
                     const data = getComparisonData();
                     exportComparisonData(data);
                });
            }
            
            const updateComparisonView = () => {
                const data = getComparisonData();
                renderComparisonChart(data);
                renderComparisonList(data);

                // Update active buttons
                const container = document.getElementById('comparison-section-container');
                if (!container) return;
                container.querySelectorAll('#comparison-mode-toggle button').forEach(b => b.classList.toggle('active', b.dataset.mode === comparisonState.mode));
                container.querySelectorAll('#comparison-timeframe-toggle button').forEach(b => b.classList.toggle('active', b.dataset.tf === comparisonState.timeframe));
            };

            const getComparisonData = () => {
                 const now = new Date();
                 const startDate = new Date();
                 switch (comparisonState.timeframe) {
                    case '7D': startDate.setDate(now.getDate() - 7); break;
                    case '30D': startDate.setDate(now.getDate() - 30); break;
                    case '90D': startDate.setDate(now.getDate() - 90); break;
                    case 'All': startDate.setTime(0); break;
                 }

                 const accountData = currentUser.accounts.map(acc => {
                    const sortedTrades = [...acc.trades].sort((a,b) => new Date(a.date) - new Date(b.date));
                    let fullHistory = [{ date: new Date(acc.creationDate), value: acc.allocatedFunds }];
                    let currentEquity = acc.allocatedFunds;
                    sortedTrades.forEach(t => {
                        currentEquity += t.pnl;
                        fullHistory.push({ date: new Date(t.date), value: currentEquity });
                    });
                    
                    const startIndex = fullHistory.findIndex(p => p.date >= startDate);
                    if (startIndex === -1 && fullHistory.length > 0 && fullHistory[fullHistory.length - 1].date < startDate) return null; // Account inactive in period

                    const baselineIndex = startIndex > 0 ? startIndex -1 : 0;
                    const baselinePoint = fullHistory[baselineIndex] || { date: new Date(), value: acc.allocatedFunds };
                    let periodHistory = fullHistory.slice(baselineIndex);
                    
                    if (periodHistory.length < 2) periodHistory.push({...periodHistory[0], date: now});

                    const lastPoint = periodHistory[periodHistory.length -1];
                    const pnlPercent = baselinePoint.value !== 0 ? ((lastPoint.value - baselinePoint.value) / baselinePoint.value) * 100 : 0;
                    
                    return {
                        id: acc.id,
                        name: acc.name,
                        allocatedFunds: acc.allocatedFunds,
                        equity: acc.equity,
                        pnlPercent: pnlPercent,
                        history: periodHistory,
                        status: getPerformanceStatus(lastPoint.value, baselinePoint.value)
                    }
                 }).filter(Boolean);
                 
                 return accountData;
            }
            
            const createSmoothPath = (points, tension = 0.2) => {
                if (points.length < 2) return '';

                let d = `M ${points[0][0].toFixed(2)},${points[0][1].toFixed(2)}`;

                for (let i = 0; i < points.length - 1; i++) {
                    const p0 = points[i - 1] || points[i];
                    const p1 = points[i];
                    const p2 = points[i + 1];
                    const p3 = points[i + 2] || p2;

                    const lenX1 = p2[0] - p0[0];
                    const lenY1 = p2[1] - p0[1];
                    const angle1 = Math.atan2(lenY1, lenX1);
                    const len1 = Math.sqrt(lenX1**2 + lenY1**2);
                    const c1x = p1[0] + Math.cos(angle1) * len1 * tension;
                    const c1y = p1[1] + Math.sin(angle1) * len1 * tension;
                    
                    const lenX2 = p3[0] - p1[0];
                    const lenY2 = p3[1] - p1[1];
                    const angle2 = Math.atan2(lenY2, lenX2);
                    const len2 = Math.sqrt(lenX2**2 + lenY2**2);
                    const c2x = p2[0] - Math.cos(angle2) * len2 * tension;
                    const c2y = p2[1] - Math.sin(angle2) * len2 * tension;
                    
                    d += ` C ${c1x.toFixed(2)},${c1y.toFixed(2)} ${c2x.toFixed(2)},${c2y.toFixed(2)} ${p2[0].toFixed(2)},${p2[1].toFixed(2)}`;
                }
                return d;
            };

            const renderComparisonChart = (data) => {
                const container = document.getElementById('comparison-chart-container');
                const legendContainer = document.getElementById('comparison-chart-legend');
                if (!container || !legendContainer) return;

                const visibleData = data.filter(d => comparisonState.visibleAccounts.has(d.id));

                if (visibleData.length === 0 || visibleData.every(d => d.history.length < 2)) {
                    container.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color: var(--text-secondary);">Select an account from the legend to display.</div>`;
                } else {
                    container.innerHTML = `<div class="comparison-chart-tooltip"></div>`;
                    const tooltip = container.querySelector('.comparison-chart-tooltip');
                    
                    const colors = ['#58A6FF', '#39C5CF', '#A371F7', '#D29922', '#DA3633', '#238636'];

                    const margin = { top: 20, right: 20, bottom: 40, left: 60 };
                    const width = container.clientWidth > 0 ? container.clientWidth - margin.left - margin.right : 300;
                    const height = container.clientHeight > 0 ? container.clientHeight - margin.top - margin.bottom : 200;

                    // --- 1. Prepare data and scales ---
                    const allPoints = [].concat(...visibleData.map(d => {
                        const baseline = d.history[0].value || 1;
                        return d.history.map(p => ({
                            date: p.date,
                            value: comparisonState.mode === 'normalized' ? (p.value / baseline) * 100 : p.value
                        }));
                    }));

                    const minDate = Math.min(...allPoints.map(p => p.date.getTime()));
                    const maxDate = Math.max(...allPoints.map(p => p.date.getTime()));
                    const dateRange = maxDate - minDate === 0 ? 1 : maxDate - minDate;

                    const allValues = allPoints.map(p => p.value);
                    const minVal = Math.min(...allValues);
                    const maxVal = Math.max(...allValues);
                    const valRange = maxVal - minVal === 0 ? 1 : maxVal - minVal;
                    
                    const yDomain = [minVal - valRange * 0.05, maxVal + valRange * 0.05];
                    const yRange = yDomain[1] - yDomain[0];

                    const x = (date) => (date.getTime() - minDate) / dateRange * width;
                    const y = (val) => height - ((val - yDomain[0]) / yRange) * height;

                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute('class', 'comparison-chart-svg');
                    svg.setAttribute('viewBox', `0 0 ${container.clientWidth} ${container.clientHeight}`);
                    
                    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    g.setAttribute('transform', `translate(${margin.left},${margin.top})`);

                    // --- 2. Create Defs (Gradients) ---
                    let defsHTML = '';
                    visibleData.forEach((d, i) => {
                        const color = colors[i % colors.length];
                        defsHTML += `
                            <linearGradient id="gradient-${d.id}" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="${color}" stop-opacity="0.4"/>
                                <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
                            </linearGradient>`;
                    });
                    g.innerHTML = `<defs>${defsHTML}</defs>`;
                    
                    // --- 3. Create Axes ---
                    const yAxisGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    const numYTicks = 5;
                    for (let i = 0; i <= numYTicks; i++) {
                        const val = yDomain[0] + (yRange / numYTicks) * i;
                        const yPos = y(val);
                        yAxisGroup.innerHTML += `
                            <line x1="0" y1="${yPos}" x2="${width}" y2="${yPos}" stroke="var(--border-color)" stroke-dasharray="2,2" />
                            <text x="-10" y="${yPos}" dy="0.32em" fill="var(--text-secondary)" style="font-size:11px;" text-anchor="end">
                                ${comparisonState.mode === 'normalized' ? `${val.toFixed(0)}%` : formatCurrency(val)}
                            </text>`;
                    }
                    g.appendChild(yAxisGroup);

                    const xAxisGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    const numXTicks = 4;
                    for (let i = 0; i <= numXTicks; i++) {
                        const date = new Date(minDate + (dateRange / numXTicks) * i);
                        const xPos = x(date);
                        xAxisGroup.innerHTML += `
                            <text x="${xPos}" y="${height + 20}" dy="0.71em" fill="var(--text-secondary)" style="font-size:11px;" text-anchor="middle">
                                ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                            </text>`;
                    }
                    g.appendChild(xAxisGroup);

                    // --- 4. Create Paths (Area & Line) ---
                    visibleData.forEach((d, i) => {
                        const color = colors[i % colors.length];
                        const baseline = d.history[0].value || 1;
                        
                        // Map data to [x, y] coordinates
                        const xyPoints = d.history.map(p => {
                            const value = comparisonState.mode === 'normalized' ? (p.value / baseline) * 100 : p.value;
                            return [x(p.date), y(value)];
                        });
                        
                        if (xyPoints.length < 2) return;

                        // Create the smooth line path
                        const linePathData = createSmoothPath(xyPoints);

                        // Create the area path from the line path
                        const firstPoint = xyPoints[0];
                        const lastPoint = xyPoints[xyPoints.length - 1];
                        const areaPathData = `${linePathData} L ${lastPoint[0].toFixed(2)},${height} L ${firstPoint[0].toFixed(2)},${height} Z`;

                        const areaPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        areaPath.setAttribute('d', areaPathData);
                        areaPath.setAttribute('fill', `url(#gradient-${d.id})`);
                        g.appendChild(areaPath);

                        const linePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        linePath.setAttribute('d', linePathData);
                        linePath.setAttribute('fill', 'none');
                        linePath.setAttribute('stroke', color);
                        linePath.setAttribute('stroke-width', '2.5');
                        linePath.setAttribute('stroke-linejoin', 'round');
                        linePath.setAttribute('stroke-linecap', 'round');
                        g.appendChild(linePath);
                    });


                    // --- 5. Create Interactivity Layer ---
                    const hoverGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    hoverGroup.style.opacity = 0;
                    
                    const hoverLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    hoverLine.setAttribute('y1', 0);
                    hoverLine.setAttribute('y2', height);
                    hoverLine.setAttribute('stroke', 'var(--text-secondary)');
                    hoverLine.setAttribute('stroke-width', '1');
                    hoverLine.setAttribute('stroke-dasharray', '3,3');
                    hoverGroup.appendChild(hoverLine);

                    visibleData.forEach((d, i) => {
                        const color = colors[i % colors.length];
                        const hoverCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                        hoverCircle.setAttribute('r', '5');
                        hoverCircle.setAttribute('fill', color);
                        hoverCircle.setAttribute('stroke', 'var(--bg-secondary)');
                        hoverCircle.setAttribute('stroke-width', '2');
                        hoverCircle.dataset.accountId = d.id;
                        hoverGroup.appendChild(hoverCircle);
                    });
                    g.appendChild(hoverGroup);
                    
                    const overlay = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    overlay.setAttribute('width', width);
                    overlay.setAttribute('height', height);
                    overlay.style.fill = 'none';
                    overlay.style.pointerEvents = 'all';
                    g.appendChild(overlay);

                    overlay.addEventListener('mousemove', (e) => {
                        hoverGroup.style.opacity = 1;
                        tooltip.style.opacity = 1;
                        
                        const mouseX = e.clientX - container.getBoundingClientRect().left - margin.left;
                        const mouseDate = new Date(minDate + (mouseX / width) * dateRange);
                        
                        const firstAccountHistory = visibleData[0].history;
                        let closestIndex = 0;
                        let minDiff = Infinity;
                        firstAccountHistory.forEach((p, idx) => {
                            const diff = Math.abs(p.date - mouseDate);
                            if (diff < minDiff) {
                                minDiff = diff;
                                closestIndex = idx;
                            }
                        });

                        const pointDate = firstAccountHistory[closestIndex].date;
                        const pointX = x(pointDate);
                        
                        hoverLine.setAttribute('x1', pointX);
                        hoverLine.setAttribute('x2', pointX);

                        let tooltipHTML = `<div class="tooltip-title">${pointDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</div>`;
                        
                        visibleData.forEach((d, i) => {
                            const color = colors[i % colors.length];
                            const baseline = d.history[0].value || 1;
                            const point = d.history[closestIndex];
                            if (!point) return;
                            
                            const value = comparisonState.mode === 'normalized' ? (point.value / baseline) * 100 : p.value;
                            const pointY = y(value);
                            
                            const circle = hoverGroup.querySelector(`circle[data-account-id="${d.id}"]`);
                            if(circle) {
                                circle.setAttribute('cx', pointX);
                                circle.setAttribute('cy', pointY);
                            }
                            
                            tooltipHTML += `
                                <div class="tooltip-item">
                                    <div class="tooltip-swatch" style="background-color: ${color}"></div>
                                    <span>${d.name}: <strong>${comparisonState.mode === 'normalized' ? `${value.toFixed(2)}%` : formatCurrency(value)}</strong></span>
                                </div>`;
                        });
                        
                        tooltip.innerHTML = tooltipHTML;
                        
                        const tooltipRect = tooltip.getBoundingClientRect();
                        let tooltipX = e.clientX - container.getBoundingClientRect().left + 15;
                        let tooltipY = e.clientY - container.getBoundingClientRect().top + 15;
                        if (tooltipX + tooltipRect.width > container.clientWidth) {
                            tooltipX = e.clientX - container.getBoundingClientRect().left - tooltipRect.width - 15;
                        }
                        if (tooltipY + tooltipRect.height > container.clientHeight) {
                            tooltipY = e.clientY - container.getBoundingClientRect().top - tooltipRect.height - 15;
                        }
                        tooltip.style.transform = `translate(${tooltipX}px, ${tooltipY}px)`;
                    });
                    
                    overlay.addEventListener('mouseleave', () => {
                        hoverGroup.style.opacity = 0;
                        tooltip.style.opacity = 0;
                    });

                    svg.appendChild(g);
                    container.appendChild(svg);
                }
                
                const colors = ['#58A6FF', '#39C5CF', '#A371F7', '#D29922', '#DA3633', '#238636'];
                legendContainer.innerHTML = data.map((d, i) => `
                    <div class="legend-item ${comparisonState.visibleAccounts.has(d.id) ? '' : 'hidden'}" data-id="${d.id}">
                        <div class="legend-swatch" style="background-color: ${colors[i % colors.length]}"></div>
                        <span>${d.name}</span>
                        <span class="legend-pnl ${d.pnlPercent >= 0 ? 'pnl-profit' : 'pnl-loss'}">(${d.pnlPercent.toFixed(2)}%)</span>
                    </div>`).join('');
                
                legendContainer.querySelectorAll('.legend-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = parseInt(item.dataset.id);
                        if (comparisonState.visibleAccounts.has(id)) {
                            comparisonState.visibleAccounts.delete(id);
                        } else {
                            comparisonState.visibleAccounts.add(id);
                        }
                        saveComparisonState();
                        updateComparisonView();
                    });
                });
            }
            
            const renderComparisonList = (data) => {
                const container = document.getElementById('comparison-list-container');
                if (!container) return;

                const sortedData = [...data].sort((a,b) => {
                    const order = comparisonState.sortOrder === 'asc' ? 1 : -1;
                    return (a[comparisonState.sortBy] < b[comparisonState.sortBy]) ? -1 * order : (a[comparisonState.sortBy] > b[comparisonState.sortBy]) ? 1 * order : 0;
                });

                container.innerHTML = `
                <table class="comparison-table">
                    <thead><tr>
                        <th>#</th>
                        <th>Account</th>
                        <th>Sparkline</th>
                        <th data-sort="pnlPercent">P/L % <span class="sort-icon">${comparisonState.sortBy === 'pnlPercent' ? (comparisonState.sortOrder === 'desc' ? '' : '') : ''}</span></th>
                        <th data-sort="equity">Equity <span class="sort-icon">${comparisonState.sortBy === 'equity' ? (comparisonState.sortOrder === 'desc' ? '' : '') : ''}</span></th>
                    </tr></thead>
                    <tbody>${sortedData.map((d, i) => `
                        <tr data-id="${d.id}">
                            <td class="rank-cell">${i+1}</td>
                            <td>
                                <div>${d.name}</div>
                                <div style="font-size:0.8rem; color:var(--text-secondary);">${formatCurrency(d.allocatedFunds)}</div>
                            </td>
                            <td>${generateSparklineSVG(d.history, d.status)}</td>
                            <td class="${d.pnlPercent >= 0 ? 'pnl-profit' : 'pnl-loss'}">${d.pnlPercent.toFixed(2)}%</td>
                            <td>${formatCurrency(d.equity)} <div class="status-dot ${d.status}" style="display:inline-block; vertical-align:middle; margin-left: 5px;"></div></td>
                        </tr>`).join('')}
                    </tbody>
                </table>`;

                container.querySelectorAll('th[data-sort]').forEach(th => {
                    th.addEventListener('click', () => {
                        const sortBy = th.dataset.sort;
                        if (comparisonState.sortBy === sortBy) {
                            comparisonState.sortOrder = comparisonState.sortOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            comparisonState.sortBy = sortBy;
                            comparisonState.sortOrder = 'desc';
                        }
                        saveComparisonState();
                        renderComparisonList(data);
                    });
                });
                container.querySelectorAll('tbody tr').forEach(row => {
                    row.addEventListener('click', () => renderAccountDetail(parseInt(row.dataset.id)));
                });
            }

            const generateSparklineSVG = (history, status) => {
                if (history.length < 2) return '';
                const values = history.map(p => p.value);
                const width = 80, height = 30, padding = 2;
                const min = Math.min(...values), max = Math.max(...values);
                const range = max - min === 0 ? 1 : max - min;
                const points = values.map((v, i) => `${(i/(values.length-1))*(width-padding*2)+padding},${height-(((v-min)/range)*(height-padding*2)+padding)}`).join(' ');
                const color = `var(--status-${status === 'average' ? 'avg' : status})`;

                return `<svg class="sparkline-svg" viewBox="0 0 ${width} ${height}"><polyline class="sparkline-line" points="${points}" stroke="${color}"></polyline></svg>`;
            };

            const exportComparisonData = (data) => {
                 let csvContent = "data:text/csv;charset=utf-8,Account,Date,Equity\r\n";
                 data.forEach(acc => {
                     acc.history.forEach(point => {
                         csvContent += `${acc.name},${point.date.toISOString()},${point.value}\r\n`;
                     });
                 });
                 const encodedUri = encodeURI(csvContent);
                 const link = document.createElement("a");
                 link.setAttribute("href", encodedUri);
                 link.setAttribute("download", `edgeplus_comparison_${new Date().toISOString().split('T')[0]}.csv`);
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
            }
            
            // --- AI ASSISTANT MODULE ---
            const assistant = {
                panel: document.getElementById('assistant-panel'),
                fab: document.getElementById('assistant-fab'),
                body: document.getElementById('assistant-body'),
                form: document.getElementById('assistant-input-form'),
                input: document.getElementById('assistant-input'),
                sendBtn: document.getElementById('assistant-send-btn'),
                suggestions: document.getElementById('assistant-suggestions'),
                messages: [],
                cloudAIEnabled: false, // Privacy First: Off by default

                init() {
                    this.fab.addEventListener('click', () => this.togglePanel());
                    this.form.addEventListener('submit', (e) => this.handleUserSubmit(e));
                    this.input.addEventListener('input', () => this.handleInput());
                    this.suggestions.addEventListener('click', (e) => {
                        if (e.target.classList.contains('suggestion-chip')) {
                            this.input.value = e.target.textContent;
                            this.handleUserSubmit(new Event('submit'));
                        }
                    });
                    
                    this.addMessage('assistant', "Hello! I'm your EdgePlus Assistant. How can I help you analyze your trading data today?");
                    setTimeout(() => this.fab.classList.add('pulse'), 3000);
                },

                togglePanel() {
                    this.panel.classList.toggle('visible');
                    if(this.panel.classList.contains('visible')) {
                        this.fab.classList.remove('pulse');
                        this.input.focus();
                    }
                },

                handleInput() {
                    this.input.style.height = 'auto';
                    this.input.style.height = `${this.input.scrollHeight}px`;
                    this.sendBtn.disabled = this.input.value.trim() === '';
                },

                async handleUserSubmit(e) {
                    e.preventDefault();
                    const query = this.input.value.trim();
                    if (!query) return;

                    this.addMessage('user', query);
                    this.input.value = '';
                    this.handleInput();

                    this.addMessage('assistant', 'Thinking...', true);
                    
                    // Simulate thinking time and process query
                    setTimeout(async () => {
                        const response = await this.processQuery(query);
                        this.updateLastMessage(response);
                    }, 500);
                },

                addMessage(sender, content, isThinking = false) {
                    const message = {
                        id: Date.now(),
                        sender,
                        content,
                        isThinking
                    };
                    this.messages.push(message);
                    this.renderMessages();
                },

                updateLastMessage(newContent) {
                    if (this.messages.length > 0) {
                        const lastMessage = this.messages[this.messages.length - 1];
                        lastMessage.content = newContent;
                        lastMessage.isThinking = false;
                        this.renderMessages();
                    }
                },

                renderMessages() {
                    this.body.innerHTML = this.messages.map(msg => {
                        const userAvatar = `<div class="assistant-avatar" style="background-color: var(--bg-primary);"><img src="${currentUser.profilePic}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;"></div>`;
                        const assistantAvatar = `<div class="assistant-avatar" style="background: linear-gradient(45deg, var(--accent-blue), var(--accent-cyan));"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="4" y="12" width="8" height="8" rx="2"/><path d="M8 12v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2"/></svg></div>`;
                        
                        let thinkingIndicator = msg.isThinking ? `<div style="display: flex; gap: 4px; align-items: center; margin-top: 8px;"><span class="insight-dot yellow" style="margin:0; width:8px; height:8px;"></span><span class="insight-dot green" style="margin:0; width:8px; height:8px;"></span><span class="insight-dot red" style="margin:0; width:8px; height:8px;"></span></div>` : msg.content;

                        return `
                            <div class="assistant-message ${msg.sender}">
                                ${msg.sender === 'user' ? userAvatar : assistantAvatar}
                                <div class="assistant-message-content">
                                    ${thinkingIndicator}
                                </div>
                            </div>
                        `;
                    }).join('');
                    this.body.scrollTop = this.body.scrollHeight;
                },

                async processQuery(query) {
                    // This is a local-first, rule-based engine.
                    // A check for `this.cloudAIEnabled` could be added here to call an external LLM.
                    const q = query.toLowerCase();
                    const accounts = this.data.getAccounts();

                    // --- Intent Matching ---
                    if (q.includes('p/l') || q.includes('profit') || q.includes('loss')) {
                        return this.handlers.getProfitAndLoss(q, accounts);
                    }
                    if (q.includes('compare')) {
                        return this.handlers.compareAccounts(q, accounts);
                    }
                    if (q.includes('trades on') || (q.includes('show') && q.includes('trades'))) {
                        return this.handlers.listTrades(q, accounts);
                    }
                     if (q.includes('mistake')) {
                        return this.handlers.analyzeMistakes(q, accounts);
                    }
                    if (q.includes('withdrawal')) {
                        return this.handlers.getWithdrawals(q, accounts);
                    }
                    if (q.includes('goal') || q.includes('target')) {
                        return this.handlers.checkGoal(q, accounts, currentUser.goals);
                    }

                    return "I'm sorry, I can only provide information about account P/L, comparisons, trade history, mistakes, withdrawals, and goals right now. Please try rephrasing your question.";
                },

                data: {
                    getAccounts: () => currentUser.accounts,
                    getTrades(accountId, { fromDate, toDate }) {
                        const account = currentUser.accounts.find(a => a.id === accountId);
                        if (!account) return [];
                        return account.trades.filter(t => {
                            const tradeDate = new Date(t.date);
                            if (fromDate && tradeDate < fromDate) return false;
                            if (toDate && tradeDate > toDate) return false;
                            return true;
                        });
                    },
                    getWithdrawals({ fromDate, toDate, accountId = null }) {
                        let allWithdrawals = [];
                        const accountsToScan = accountId ? [currentUser.accounts.find(a=>a.id === accountId)] : currentUser.accounts;

                        accountsToScan.forEach(acc => {
                            if (acc && acc.withdrawals) {
                                acc.withdrawals.forEach(w => {
                                    const withdrawalDate = new Date(w.date);
                                     if ((!fromDate || withdrawalDate >= fromDate) && (!toDate || withdrawalDate <= toDate)) {
                                        allWithdrawals.push({ ...w, accountName: acc.name });
                                     }
                                });
                            }
                        });
                        return allWithdrawals;
                    },
                    computeStats(trades, startingEquity) {
                        if (trades.length === 0) return { totalPL: 0, winRate: 0, maxDrawdown: 0, avgPL: 0, bestTrade: 0, worstTrade: 0 };

                        const totalPL = trades.reduce((sum, t) => sum + t.pnl, 0);
                        const winRate = (trades.filter(t => t.pnl > 0).length / trades.length) * 100;
                        const avgPL = totalPL / trades.length;
                        const bestTrade = Math.max(...trades.map(t => t.pnl));
                        const worstTrade = Math.min(...trades.map(t => t.pnl));

                        let peakEquity = startingEquity;
                        let maxDrawdown = 0;
                        let currentEquity = startingEquity;
                        trades.forEach(trade => {
                            currentEquity += trade.pnl;
                            if (currentEquity > peakEquity) {
                                peakEquity = currentEquity;
                            }
                            const drawdown = peakEquity - currentEquity;
                            if (drawdown > maxDrawdown) {
                                maxDrawdown = drawdown;
                            }
                        });

                        return { totalPL, winRate, maxDrawdown, avgPL, bestTrade, worstTrade };
                    }
                },

                handlers: {
                    getProfitAndLoss(query, accounts) {
                        const daysMatch = query.match(/(\d+)\s*days?/);
                        const days = daysMatch ? parseInt(daysMatch[1]) : 7; // Default to 7 days
                        
                        let account = null;
                        if (accounts.length === 1) {
                            account = accounts[0];
                        } else {
                            const accountMatch = accounts.find(a => query.toLowerCase().includes(a.name.toLowerCase()));
                            if (accountMatch) {
                                account = accountMatch;
                            }
                        }

                        if (!account && accounts.length > 1) {
                            return `Please specify which account you'd like to see the P/L for. Your active accounts are: ${accounts.map(a=>`'${a.name}'`).join(', ')}.`;
                        }
                        if (!account) {
                            return "No active accounts found to analyze.";
                        }
                        
                        const toDate = new Date();
                        const fromDate = new Date();
                        fromDate.setDate(toDate.getDate() - days);

                        const trades = assistant.data.getTrades(account.id, { fromDate, toDate });

                        if (trades.length === 0) {
                            return `No trades found for '${account.name}' in the last ${days} days.`;
                        }

                        const stats = assistant.data.computeStats(trades, account.allocatedFunds);
                        const dailyData = trades.reduce((acc, trade) => {
                            const day = new Date(trade.date).toISOString().split('T')[0];
                            acc[day] = (acc[day] || 0) + trade.pnl;
                            return acc;
                        }, {});

                        const historyForSparkline = Object.values(dailyData).reduce((acc, pnl) => {
                            acc.push({ value: (acc.length > 0 ? acc[acc.length-1].value : 0) + pnl });
                            return acc;
                        }, []);
                        
                        const sparkline = generateSparklineSVG(historyForSparkline, stats.totalPL >= 0 ? 'good' : 'bad');

                        return `
                            <h4>P/L for ${account.name} (Last ${days} Days)</h4>
                            <p><strong>Total Net P/L: <span class="${stats.totalPL >= 0 ? 'pnl-profit' : 'pnl-loss'}">${formatCurrency(stats.totalPL)}</span></strong></p>
                            <ul>
                                <li><strong>Win Rate:</strong> ${stats.winRate.toFixed(1)}%</li>
                                <li><strong>Average P/L per trade:</strong> ${formatCurrency(stats.avgPL)}</li>
                                <li><strong>Best / Worst Trade:</strong> ${formatCurrency(stats.bestTrade)} / ${formatCurrency(stats.worstTrade)}</li>
                            </ul>
                            ${sparkline}
                            <div class="message-toolbar">
                                <button class="toolbar-btn" onclick="document.dispatchEvent(new CustomEvent('assistantAction', { detail: { action: 'openAccount', accountId: ${account.id} } }))">Open Account</button>
                            </div>`;
                    },

                    compareAccounts(query, accounts) {
                        const daysMatch = query.match(/(\d+)\s*days?/);
                        const days = daysMatch ? parseInt(daysMatch[1]) : 30;
                        const toDate = new Date();
                        const fromDate = new Date();
                        fromDate.setDate(toDate.getDate() - days);

                        let accountsToCompare = accounts;
                        if (query.includes('funded') || query.includes('passed')) {
                            accountsToCompare = accounts.filter(a => a.phase === 'Passed');
                        }

                        if (accountsToCompare.length < 1) {
                            return "No accounts found to compare for the specified criteria.";
                        }

                        const data = accountsToCompare.map(acc => {
                            const trades = assistant.data.getTrades(acc.id, { fromDate, toDate });
                            const stats = assistant.data.computeStats(trades, acc.allocatedFunds);
                            const disciplinedTrades = trades.filter(t => t.stopLossUsed === 'Yes' && (!t.mistakes || t.mistakes.length === 0)).length;
                            const disciplineScore = trades.length > 0 ? (disciplinedTrades / trades.length) * 100 : 100;
                            return { name: acc.name, ...stats, disciplineScore };
                        }).sort((a,b) => b.totalPL - a.totalPL);

                        return `
                            <h4>Account Comparison (Last ${days} Days)</h4>
                            <table>
                                <thead><tr><th>Account</th><th>Net P/L</th><th>Win Rate</th><th>Max DD</th><th>Discipline</th></tr></thead>
                                <tbody>
                                    ${data.map(d => `
                                        <tr>
                                            <td>${d.name}</td>
                                            <td class="${d.totalPL >= 0 ? 'pnl-profit' : 'pnl-loss'}">${formatCurrency(d.totalPL)}</td>
                                            <td>${d.winRate.toFixed(1)}%</td>
                                            <td class="pnl-loss">${formatCurrency(d.maxDrawdown)}</td>
                                            <td>${d.disciplineScore.toFixed(0)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    },
                    
                    listTrades(query, accounts) {
                         // Simple date parser for YYYY-MM-DD
                        const dateMatch = query.match(/(\d{4}-\d{2}-\d{2})/);
                        if (!dateMatch) {
                            return "Please specify a date in YYYY-MM-DD format to find trades.";
                        }
                        const targetDate = new Date(dateMatch[1]);
                        const fromDate = new Date(targetDate);
                        fromDate.setUTCHours(0, 0, 0, 0);
                        const toDate = new Date(targetDate);
                        toDate.setUTCHours(23, 59, 59, 999);
                        
                        let account = null;
                        if (accounts.length === 1) {
                            account = accounts[0];
                        } else {
                            const accountMatch = accounts.find(a => query.toLowerCase().includes(a.name.toLowerCase()));
                             if (accountMatch) account = accountMatch;
                        }

                        if (!account) return "Please specify which account's trades you want to see.";

                        const trades = assistant.data.getTrades(account.id, { fromDate, toDate });
                        if (trades.length === 0) {
                            return `No trades found for '${account.name}' on ${targetDate.toLocaleDateString()}.`;
                        }
                        
                        return `
                            <h4>Trades for ${account.name} on ${targetDate.toLocaleDateString()} (${trades.length} found)</h4>
                             <table>
                                <thead><tr><th>Pair</th><th>Type</th><th>P/L</th></tr></thead>
                                <tbody>
                                    ${trades.map(t => `
                                        <tr>
                                            <td>${t.pair}</td>
                                            <td>${t.type}</td>
                                            <td class="${t.pnl >= 0 ? 'pnl-profit' : 'pnl-loss'}">${formatCurrency(t.pnl)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>`;
                    },

                     analyzeMistakes(query, accounts) {
                        const daysMatch = query.match(/(\d+)\s*days?/);
                        const days = daysMatch ? parseInt(daysMatch[1]) : 60;
                        const toDate = new Date();
                        const fromDate = new Date();
                        fromDate.setDate(toDate.getDate() - days);

                        const allTrades = accounts.flatMap(acc => assistant.data.getTrades(acc.id, { fromDate, toDate }));
                        
                        const mistakeCounts = allTrades.flatMap(t => t.mistakes || []).reduce((acc, mistake) => {
                            acc[mistake] = (acc[mistake] || 0) + 1;
                            return acc;
                        }, {});

                        const sortedMistakes = Object.entries(mistakeCounts).sort(([, a], [, b]) => b - a);

                        if (sortedMistakes.length === 0) {
                            return `No mistakes were tagged in the last ${days} days. Great job!`;
                        }

                        return `
                            <h4>Top Mistakes (Last ${days} Days)</h4>
                            <ol style="padding-left: 1.5rem; margin-top: 0.5rem;">
                                ${sortedMistakes.slice(0, 3).map(([mistake, count]) => `<li>${mistake} (${count} times)</li>`).join('')}
                            </ol>
                        `;
                    },

                     getWithdrawals(query, accounts) {
                        const daysMatch = query.match(/(\d+)\s*days?/);
                        const monthMatch = query.match(/last\s*month/);
                        let days = daysMatch ? parseInt(daysMatch[1]) : (monthMatch ? 30 : null);
                        
                        const toDate = new Date();
                        const fromDate = days ? new Date() : null;
                        if(fromDate) fromDate.setDate(toDate.getDate() - days);
                        
                        const withdrawals = assistant.data.getWithdrawals({ fromDate, toDate });

                        if (withdrawals.length === 0) {
                            return "No withdrawals found in the specified period.";
                        }
                        
                        const total = withdrawals.reduce((sum, w) => sum + w.amount, 0);

                        return `
                             <h4>Withdrawal Summary ${days ? `(Last ${days} Days)`: ''}</h4>
                             <p><strong>Total Withdrawn: <span class="pnl-loss">${formatCurrency(total)}</span></strong> over ${withdrawals.length} transaction(s).</p>
                             <table>
                                <thead><tr><th>Date</th><th>Account</th><th>Amount</th></tr></thead>
                                <tbody>
                                    ${withdrawals.slice(0, 5).map(w => `
                                        <tr>
                                            <td>${new Date(w.date).toLocaleDateString()}</td>
                                            <td>${w.accountName}</td>
                                            <td class="pnl-loss">${formatCurrency(w.amount)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                             </table>
                             ${withdrawals.length > 5 ? `<p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">Showing first 5 of ${withdrawals.length}.</p>` : ''}
                        `;
                     },

                    checkGoal(query, accounts, goals) {
                        if (!goals || goals.length === 0) {
                            return `You haven't set any goals yet. You can add one from the 'Goals' page.`;
                        }

                        let goal = null;
                        const goalMatch = goals.find(g => query.toLowerCase().includes(g.title.toLowerCase()));
                        if(goalMatch) goal = goalMatch;
                        else goal = goals.find(g => g.status === 'ongoing'); // Default to first ongoing goal

                        if (!goal) return `All your goals are completed or failed. Set a new one from the 'Goals' page.`;
                        
                        // Recalculate progress (logic adapted from renderGoalsView)
                        const account = goal.accountId ? accounts.find(a => a.id === goal.accountId) : null;
                        const tradesForGoal = account 
                            ? account.trades.filter(t => new Date(t.date) >= new Date(goal.creationDate))
                            : accounts.flatMap(acc => acc.trades).filter(t => new Date(t.date) >= new Date(goal.creationDate));

                        let current = 0; let targetText = ''; let currentText = '';
                        if (goal.type === 'profit') {
                            current = tradesForGoal.reduce((sum, t) => sum + t.pnl, 0);
                            targetText = formatCurrency(goal.target);
                            currentText = formatCurrency(current);
                        } else if (goal.type === 'win_rate') {
                            const wins = tradesForGoal.filter(t => t.pnl > 0).length;
                            current = tradesForGoal.length > 0 ? (wins / tradesForGoal.length) * 100 : 0;
                            targetText = `${goal.target}%`;
                            currentText = `${current.toFixed(1)}%`;
                        } else if (goal.type === 'consistency') {
                            current = new Set(tradesForGoal.map(t => t.date.split('T')[0])).size;
                            targetText = `${goal.target} days`;
                            currentText = `${current} days`;
                        }

                        const progressPercent = Math.min((current / goal.target) * 100, 100);

                        return `
                            <h4>Goal Status: ${goal.title}</h4>
                            <p>You are at <strong>${currentText}</strong> of your <strong>${targetText}</strong> target.</p>
                             <div class="progress-bar-container" style="margin: 0.5rem 0;"><div class="progress-bar" style="width: ${progressPercent}%"></div></div>
                             <p>That's <strong>${progressPercent.toFixed(0)}%</strong> complete!</p>
                        `;
                    }
                }
            };


            // --- APP INITIALIZATION ---
            const initApp = () => {
                currentUser = users.find(u => u.email === currentUserEmail);
                if (!currentUser) { initAuth(); return; }
                
                authWrapper.classList.add('hidden');
                appWrapper.classList.remove('hidden');

                // Ensure data structure is up to date
                currentUser.goals = currentUser.goals || [];
                currentUser.deletedAccounts = currentUser.deletedAccounts || [];
                currentUser.customEntryReasons = currentUser.customEntryReasons || [];
                currentUser.accounts.forEach(acc => {
                    // MIGRATION: from balance to initialNetProfit
                    if (typeof acc.balance !== 'undefined' && typeof acc.initialNetProfit === 'undefined') {
                        const tradesPnl = acc.trades.reduce((sum, trade) => sum + trade.pnl, 0);
                        acc.initialNetProfit = (acc.equity - acc.allocatedFunds) - tradesPnl;
                        delete acc.balance;
                    }
                    if (!acc.creationDate) acc.creationDate = new Date().toISOString();
                    if (!acc.phase) acc.phase = 'Demo'; // Add phase if missing
                    acc.trades.forEach(trade => {
                        trade.mistakes = trade.mistakes || [];
                    });
                    acc.withdrawals = acc.withdrawals || [];
                });

                // Load and apply persisted comparison state
                const savedComparisonState = localStorage.getItem(`edgeplus_comparison_state_${currentUser.email}`);
                if (savedComparisonState) {
                    const parsedState = JSON.parse(savedComparisonState);
                    comparisonState = { ...comparisonState, ...parsedState };
                    if (parsedState.visibleAccounts) {
                        const currentAccountIds = new Set(currentUser.accounts.map(a => a.id));
                        comparisonState.visibleAccounts = new Set(parsedState.visibleAccounts.filter(id => currentAccountIds.has(id)));
                    }
                } else {
                    comparisonState.visibleAccounts = new Set(currentUser.accounts.map(a => a.id));
                }
                
                updateUIForCurrentUser();
                renderDashboard();
                switchView(dashboardView);
                assistant.init();

                // Custom event listener for assistant actions
                document.addEventListener('assistantAction', (e) => {
                    const { action, accountId } = e.detail;
                    if (action === 'openAccount' && accountId) {
                        renderAccountDetail(accountId);
                        assistant.togglePanel(); // Close panel after action
                    }
                });

                document.getElementById('dashboard-main').addEventListener('click', (e) => {
                    const dashboardGrid = document.getElementById('dashboard-grid-content');
                    if (!dashboardGrid || !dashboardGrid.contains(e.target)) return;
                    
                    const addBtn = e.target.closest('#add-account-btn');
                    const editBtn = e.target.closest('.edit-btn');
                    const deleteBtn = e.target.closest('.delete-btn');
                    const accountCard = e.target.closest('.account-card');
                    if (addBtn) openModal();
                    else if (editBtn) openModal(parseInt(editBtn.dataset.id));
                    else if (deleteBtn) {
                        const accountId = parseInt(deleteBtn.dataset.id);
                        if (confirm('Are you sure you want to move this account to the Trash?')) {
                            handleSoftDeleteAccount(accountId);
                        }
                    } else if (accountCard && !e.target.closest('.account-card-actions')) {
                        renderAccountDetail(parseInt(accountCard.dataset.id));
                    }
                });
                
                modal.addEventListener('click', (e) => { if (e.target.id === 'account-modal' || e.target.id === 'close-modal-btn') closeModal(); });
                goalModal.addEventListener('click', (e) => { if (e.target.id === 'goal-modal' || e.target.id === 'close-goal-modal-btn') closeGoalModal(); });
                noteModal.addEventListener('click', (e) => { if (e.target.id === 'note-modal' || e.target.id === 'close-note-modal-btn') noteModal.classList.remove('visible'); });
                withdrawalModal.addEventListener('click', (e) => { if (e.target.id === 'withdrawal-modal' || e.target.id === 'close-withdrawal-modal-btn') closeWithdrawalModal(); });
                accountForm.addEventListener('submit', handleAccountFormSubmit);
                goalForm.addEventListener('submit', handleGoalFormSubmit);
                withdrawalForm.addEventListener('submit', handleWithdrawalFormSubmit);
                
                hamburgerBtn.addEventListener('click', () => {
                    sideDrawer.classList.add('open');
                    drawerOverlay.classList.add('visible');
                });
                drawerOverlay.addEventListener('click', () => {
                    sideDrawer.classList.remove('open');
                    drawerOverlay.classList.remove('visible');
                });
                const closeDrawer = () => { sideDrawer.classList.remove('open'); drawerOverlay.classList.remove('visible'); };
                document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); renderDashboard(); switchView(dashboardView); closeDrawer(); });
                document.getElementById('nav-profile').addEventListener('click', (e) => { e.preventDefault(); renderProfileView(); closeDrawer(); });
                document.getElementById('nav-goals').addEventListener('click', (e) => { e.preventDefault(); renderGoalsView(); closeDrawer(); });
                document.getElementById('nav-exit-analysis').addEventListener('click', (e) => { e.preventDefault(); renderExitAnalysisView(); closeDrawer(); });
                document.getElementById('nav-trash').addEventListener('click', (e) => { e.preventDefault(); renderTrashView(); closeDrawer(); });
                document.getElementById('nav-withdrawal-history').addEventListener('click', (e) => { e.preventDefault(); renderWithdrawalHistoryView(); closeDrawer(); });
                document.getElementById('nav-logout').addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('edgeplus_currentUser');
                    currentUserEmail = null;
                    currentUser = null;
            
                    closeDrawer();
                    
                    appWrapper.classList.add('hidden');
                    authWrapper.classList.remove('hidden');
                });
            };

            const initAuth = () => {
                authWrapper.classList.remove('hidden');
                appWrapper.classList.add('hidden');
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = loginForm.loginEmail.value;
                    const password = loginForm.loginPassword.value;
                    const user = users.find(u => u.email === email && u.password === password);
                    if (user) {
                        localStorage.setItem('edgeplus_currentUser', email);
                        currentUserEmail = email;
                        initApp();
                    } else {
                        document.getElementById('auth-error').textContent = 'Invalid email or password.';
                    }
                });
                signupForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = signupForm.signupName.value;
                    const email = signupForm.signupEmail.value;
                    const password = signupForm.signupPassword.value;
                    if (users.some(u => u.email === email)) {
                        alert('An account with this email already exists.');
                        return;
                    }
                    const newUser = { name, email, password, profilePic: generateAvatar(name), accounts: [], goals: [], customEntryReasons: [], deletedAccounts: [] };
                    users.push(newUser);
                    saveUsers();
                    localStorage.setItem('edgeplus_currentUser', email);
                    currentUserEmail = email;
                    initApp();
                });
                showSignupBtn.addEventListener('click', () => { loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); });
                showLoginBtn.addEventListener('click', () => { signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
            };

            // --- START ---
            if (currentUserEmail) { initApp(); } 
            else { initAuth(); }
        });
    </script>
</body>
</html>